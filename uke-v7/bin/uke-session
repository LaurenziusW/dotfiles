#!/usr/bin/env bash
# ==============================================================================
# UKE Session - Window Layout Save/Restore
# ==============================================================================
# Saves and restores window positions and workspace assignments.
#
# Usage: uke-session <command> [name]
#   save <n>     Save current layout
#   restore <n>  Restore saved layout  
#   list            List saved sessions
#   delete <n>   Delete a session
# ==============================================================================
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
export UKE_ROOT="${SCRIPT_DIR%/bin}"

source "$UKE_ROOT/lib/core.sh"

SESSION_DIR="${XDG_STATE_HOME:-$HOME/.local/state}/uke/sessions"
mkdir -p "$SESSION_DIR"

CMD="${1:-help}"
NAME="${2:-default}"

# ==============================================================================
# macOS Session Functions
# ==============================================================================
save_session_macos() {
    local name="$1"
    local file="$SESSION_DIR/${name}.json"
    
    log_info "Saving session: $name"
    
    yabai -m query --windows | jq '[.[] | {
        app: .app,
        title: .title,
        space: .space,
        frame: .frame,
        floating: ."is-floating"
    }]' > "$file"
    
    ok "Session saved: $file"
}

restore_session_macos() {
    local name="$1"
    local file="$SESSION_DIR/${name}.json"
    
    if [[ ! -f "$file" ]]; then
        log_fatal "Session not found: $name"
    fi
    
    log_info "Restoring session: $name"
    
    # Read session and restore each window
    local count=0
    while read -r app space; do
        # Find window by app name
        local win_id
        win_id=$(yabai -m query --windows | jq -r ".[] | select(.app == \"$app\") | .id" | head -1)
        
        if [[ -n "$win_id" ]]; then
            yabai -m window "$win_id" --space "$space" 2>/dev/null || true
            ((count++))
        fi
    done < <(jq -r '.[] | "\(.app) \(.space)"' "$file")
    
    ok "Restored $count windows"
}

# ==============================================================================
# Linux Session Functions
# ==============================================================================
save_session_linux() {
    local name="$1"
    local file="$SESSION_DIR/${name}.json"
    
    log_info "Saving session: $name"
    
    hyprctl clients -j | jq '[.[] | {
        class: .class,
        title: .title,
        workspace: .workspace.id,
        position: {x: .at[0], y: .at[1]},
        size: {w: .size[0], h: .size[1]},
        floating: .floating
    }]' > "$file"
    
    ok "Session saved: $file"
}

restore_session_linux() {
    local name="$1"
    local file="$SESSION_DIR/${name}.json"
    
    if [[ ! -f "$file" ]]; then
        log_fatal "Session not found: $name"
    fi
    
    log_info "Restoring session: $name"
    
    local count=0
    while read -r class workspace; do
        # Find window by class
        local addr
        addr=$(hyprctl clients -j | jq -r ".[] | select(.class == \"$class\") | .address" | head -1)
        
        if [[ -n "$addr" ]]; then
            hyprctl dispatch movetoworkspacesilent "$workspace,address:$addr" 2>/dev/null || true
            ((count++))
        fi
    done < <(jq -r '.[] | "\(.class) \(.workspace)"' "$file")
    
    ok "Restored $count windows"
}

# ==============================================================================
# Common Functions
# ==============================================================================
list_sessions() {
    echo "Saved sessions:"
    for f in "$SESSION_DIR"/*.json; do
        [[ -f "$f" ]] || continue
        local name size date
        name=$(basename "$f" .json)
        size=$(jq 'length' "$f" 2>/dev/null || echo "?")
        date=$(stat -c %y "$f" 2>/dev/null | cut -d. -f1 || stat -f %Sm "$f" 2>/dev/null || echo "?")
        printf "  %-15s %3s windows  %s\n" "$name" "$size" "$date"
    done
}

delete_session() {
    local name="$1"
    local file="$SESSION_DIR/${name}.json"
    
    if [[ -f "$file" ]]; then
        rm "$file"
        ok "Deleted session: $name"
    else
        warn "Session not found: $name"
    fi
}

# ==============================================================================
# Main
# ==============================================================================
case "$CMD" in
    save)
        is_macos && save_session_macos "$NAME" || save_session_linux "$NAME"
        ;;
    restore)
        is_macos && restore_session_macos "$NAME" || restore_session_linux "$NAME"
        ;;
    list|ls)
        list_sessions
        ;;
    delete|rm)
        delete_session "$NAME"
        ;;
    help|--help|-h)
        cat << EOF
UKE Session Manager

Usage: uke-session <command> [name]

Commands:
  save <n>     Save current window layout
  restore <n>  Restore a saved layout
  list            List all saved sessions
  delete <n>   Delete a session

Examples:
  uke-session save work
  uke-session restore work
  uke-session list
EOF
        ;;
    *)
        log_fatal "Unknown command: $CMD (use: save|restore|list|delete)"
        ;;
esac
