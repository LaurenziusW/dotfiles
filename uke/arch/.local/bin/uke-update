#!/usr/bin/env bash
# ==============================================================================
# UKE Update v7.2 - Unified System Update Manager
# ==============================================================================
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

if [[ -f "$SCRIPT_DIR/../lib/core.sh" ]]; then
    export UKE_ROOT="${SCRIPT_DIR%/bin}"
    source "$SCRIPT_DIR/../lib/core.sh"
elif [[ -f "$SCRIPT_DIR/../../../shared/.local/lib/core.sh" ]]; then
    export UKE_ROOT="$(cd "$SCRIPT_DIR/../../.." && pwd)"
    source "$SCRIPT_DIR/../../../shared/.local/lib/core.sh"
else
    export UKE_ROOT="${SCRIPT_DIR%/bin}"
    ok() { echo "OK: $*"; }
    info() { echo "INFO: $*"; }
    warn() { echo "WARN: $*"; }
fi

AUR_HELPER=""
[[ -x "$(command -v yay)" ]] && AUR_HELPER="yay"
[[ -x "$(command -v paru)" ]] && AUR_HELPER="paru"

update_system() {
    info "Updating official packages..."
    sudo pacman -Syu --noconfirm && ok "System updated"
}

update_aur() {
    [[ -z "$AUR_HELPER" ]] && return 0
    info "Updating AUR..."
    "$AUR_HELPER" -Sua --noconfirm && ok "AUR updated"
}

update_uke() {
    [[ -d "$UKE_ROOT/.git" ]] || return 0
    info "Updating UKE..."
    git -C "$UKE_ROOT" pull && ok "UKE updated"
}

update_all() {
    update_system
    update_aur
    update_uke
}

case "${1:---all}" in
    --system) update_system ;;
    --aur)    update_aur ;;
    --uke)    update_uke ;;
    --all)    update_all ;;
    *)        echo "Usage: uke-update [--system|--aur|--uke|--all]" ;;
esac
