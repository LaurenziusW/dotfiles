#!/usr/bin/env bash
# ==============================================================================
# UKE Snapshot v7.2 - System Snapshot & Rollback wrapper
# ==============================================================================
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

if [[ -f "$SCRIPT_DIR/../lib/core.sh" ]]; then
    export UKE_ROOT="${SCRIPT_DIR%/bin}"
    source "$SCRIPT_DIR/../lib/core.sh"
elif [[ -f "$SCRIPT_DIR/../../../shared/.local/lib/core.sh" ]]; then
    export UKE_ROOT="$(cd "$SCRIPT_DIR/../../.." && pwd)"
    source "$SCRIPT_DIR/../../../shared/.local/lib/core.sh"
else
    export UKE_ROOT="${SCRIPT_DIR%/bin}"
    ok() { echo "OK: $*"; }
    info() { echo "INFO: $*"; }
    warn() { echo "WARN: $*"; }
fi

detect_backend() {
    if command -v snapper &>/dev/null; then echo "snapper";
    elif command -v timeshift &>/dev/null; then echo "timeshift";
    else echo "none"; fi
}

BACKEND=$(detect_backend)

create_snapshot() {
    local desc="${1:-Manual Snapshot}"
    case "$BACKEND" in
        snapper) sudo snapper create -d "$desc" -c timeline && ok "Snapper snapshot created";;
        timeshift) sudo timeshift --create --comments "$desc" --scripted && ok "Timeshift snapshot created";;
        *) warn "No backend found (snapper/timeshift)";;
    esac
}

list_snapshots() {
    case "$BACKEND" in
        snapper) sudo snapper list ;;
        timeshift) sudo timeshift --list ;;
        *) warn "No backend found" ;;
    esac
}

case "${1:-list}" in
    create) create_snapshot "${2:-Manual Snapshot}" ;;
    list)   list_snapshots ;;
    *)      echo "Usage: uke-snapshot [create|list] [desc]" ;;
esac
