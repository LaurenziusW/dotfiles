#!/usr/bin/env bash
# ==============================================================================
# UKE Config Generator v7.0 - Dynamic YAML-Driven Generation
# ==============================================================================
# Generates platform-specific configs from registry.yaml (the Single Source of Truth)
# and integrates hardware-specific ghost files from machine.profile.
#
# Features:
#   - Dynamic keybinding generation from registry.yaml
#   - Dynamic workspace/app rules from registry.yaml
#   - Hardware profile integration (ghost files)
#   - Cloud path support
#   - Unified colorscheme
#
# Usage: gen.sh [target]
#   target: skhd | yabai | hyprland | gather | all
# ==============================================================================
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/core.sh"

# ==============================================================================
# Verify Dependencies
# ==============================================================================
check_yq() {
    if ! command -v yq &>/dev/null; then
        log_warn "yq not found - falling back to static generation"
        log_warn "Install yq for dynamic YAML parsing: brew install yq (macOS) or pacman -S go-yq (Arch)"
        return 1
    fi
    return 0
}

# ==============================================================================
# Registry Path Resolution
# ==============================================================================
REGISTRY="$UKE_CONFIG/registry.yaml"

ensure_registry() {
    if [[ ! -f "$REGISTRY" ]]; then
        log_fatal "Registry not found: $REGISTRY"
    fi
}

# ==============================================================================
# Generated File Header
# ==============================================================================
gen_header() {
    local format="$1"
    local file_desc="${2:-}"
    
    case "$format" in
        conf|sh)
            cat << EOF
# ==============================================================================
# ${file_desc:-AUTO-GENERATED BY UKE v$UKE_VERSION}
# ==============================================================================
# Source: $REGISTRY
# Generated: $(date -Iseconds)
# Platform: $UKE_OS
#
# DO NOT EDIT DIRECTLY - Regenerate with: uke gen
# ==============================================================================

EOF
            ;;
        lua)
            cat << EOF
-- ==============================================================================
-- ${file_desc:-AUTO-GENERATED BY UKE v$UKE_VERSION}
-- ==============================================================================
-- Source: $REGISTRY
-- Generated: $(date -Iseconds)
-- Platform: $UKE_OS
--
-- DO NOT EDIT DIRECTLY - Regenerate with: uke gen
-- ==============================================================================

EOF
            ;;
    esac
}

# ==============================================================================
# YAML Query Helpers
# ==============================================================================
# Get a value from registry.yaml with a default
reg_get() {
    local path="$1"
    local default="${2:-}"
    yaml_get "$REGISTRY" "$path" "$default"
}

# Get keys from a path
reg_keys() {
    local path="$1"
    yaml_keys "$REGISTRY" "$path"
}

# Get array values from a path
reg_array() {
    local path="$1"
    yaml_array "$REGISTRY" "$path"
}

# Get modifier for current platform
get_modifier() {
    local mod_name="$1"
    local platform_key
    is_macos && platform_key="macos" || platform_key="linux"
    reg_get ".modifiers.${mod_name}.${platform_key}"
}

# Get app name for current platform
get_app_name() {
    local app_key="$1"
    local platform_key
    is_macos && platform_key="macos" || platform_key="linux"
    reg_get ".apps.${app_key}.${platform_key}"
}

# ==============================================================================
# Colorscheme (from registry or defaults)
# ==============================================================================
get_color() {
    local color_name="$1"
    local default="$2"
    local theme_color
    theme_color=$(reg_get ".theme.colors.${color_name}")
    echo "${theme_color:-$default}"
}

# Default Nord colorscheme
COLOR_ACCENT=$(get_color "accent" "#88c0d0")
COLOR_BG=$(get_color "background" "#2e3440")
COLOR_BG_LIGHT=$(get_color "bg_light" "#3b4252")
COLOR_BORDER_ACTIVE=$(get_color "border_active" "88c0d0")
COLOR_BORDER_INACTIVE=$(get_color "border_inactive" "3b4252")

# ==============================================================================
# Generate skhd config (macOS)
# ==============================================================================
gen_skhd() {
    local out="$UKE_GEN/skhd/skhdrc"
    mkdir -p "$(dirname "$out")"
    
    log_info "Generating skhd config..."
    
    # Get modifiers
    local PRIMARY=$(get_modifier "primary")
    local PRIMARY_SHIFT=$(get_modifier "primary_shift")
    local TERTIARY=$(get_modifier "tertiary")
    local LAUNCHER=$(get_modifier "launcher")
    local BUNCH=$(get_modifier "bunch")
    
    {
        gen_header "conf" "SKHD CONFIG - Keyboard Shortcuts (macOS)"
        
        cat << 'STATIC_BINDINGS'
# ==============================================================================
# Smart Focus & Focus History
# ==============================================================================
cmd - escape : yabai -m window --focus mouse
cmd + shift - 0x32 : yabai -m window --focus recent

# ==============================================================================
# Window Focus Navigation (PRIMARY: Cmd + hjkl)
# ==============================================================================
cmd - h : yabai -m window --focus west
cmd - j : yabai -m window --focus south
cmd - k : yabai -m window --focus north
cmd - l : yabai -m window --focus east

# ==============================================================================
# Window Movement (PRIMARY + SHIFT: Cmd+Shift + hjkl)
# ==============================================================================
cmd + shift - h : yabai -m window --warp west
cmd + shift - j : yabai -m window --warp south
cmd + shift - k : yabai -m window --warp north
cmd + shift - l : yabai -m window --warp east

# ==============================================================================
# Window Resizing (TERTIARY: Alt+Shift + hjkl)
# ==============================================================================
alt + shift - h : yabai -m window --resize left:-50:0
alt + shift - j : yabai -m window --resize bottom:0:50
alt + shift - k : yabai -m window --resize top:0:-50
alt + shift - l : yabai -m window --resize right:50:0

# ==============================================================================
# Launch Terminal
# ==============================================================================
cmd - return : open -a WezTerm

# ==============================================================================
# Window Controls
# ==============================================================================
cmd + shift - f : yabai -m window --toggle zoom-fullscreen
cmd + shift - space : yabai -m window --toggle float
cmd + shift - 0x2A : yabai -m window --toggle split

# ==============================================================================
# Advanced Layout Controls
# ==============================================================================
cmd + ctrl - s : yabai -m window --insert stack
cmd + shift - r : yabai -m space --rotate 90
cmd + shift - x : yabai -m space --mirror x-axis
cmd + shift - y : yabai -m space --mirror y-axis
cmd + shift - b : yabai -m space --balance
cmd + ctrl - t : yabai -m space --layout $(yabai -m query --spaces --space | jq -r 'if .type == "bsp" then "stack" else "bsp" end')

# ==============================================================================
# Workspace Navigation (PRIMARY + Number)
# ==============================================================================
cmd - 1 : yabai -m space --focus 1
cmd - 2 : yabai -m space --focus 2
cmd - 3 : yabai -m space --focus 3
cmd - 4 : yabai -m space --focus 4
cmd - 5 : yabai -m space --focus 5
cmd - 6 : yabai -m space --focus 6
cmd - 7 : yabai -m space --focus 7
cmd - 8 : yabai -m space --focus 8
cmd - 9 : yabai -m space --focus 9
cmd - 0x1D : yabai -m space --focus 10
cmd - 0x21 : yabai -m space --focus prev
cmd - 0x1E : yabai -m space --focus next

# ==============================================================================
# Move Window to Workspace (PRIMARY + SHIFT + Number)
# ==============================================================================
cmd + shift - 1 : yabai -m window --space 1 --focus
cmd + shift - 2 : yabai -m window --space 2 --focus
cmd + shift - 3 : yabai -m window --space 3 --focus
cmd + shift - 4 : yabai -m window --space 4 --focus
cmd + shift - 5 : yabai -m window --space 5 --focus
cmd + shift - 6 : yabai -m window --space 6 --focus
cmd + shift - 7 : yabai -m window --space 7 --focus
cmd + shift - 8 : yabai -m window --space 8 --focus
cmd + shift - 9 : yabai -m window --space 9 --focus
cmd + shift - 0x1D : yabai -m window --space 10 --focus

# ==============================================================================
# Gather Windows (Cmd + `)
# ==============================================================================
cmd - 0x32 : $HOME/.local/bin/uke-gather

# ==============================================================================
# Scratchpads
# ==============================================================================
cmd + alt - 0x32 : $HOME/.local/bin/uke-scratchpad terminal
cmd + alt - n : $HOME/.local/bin/uke-scratchpad notes
cmd + alt - m : $HOME/.local/bin/uke-scratchpad music

# ==============================================================================
# Smart App Launchers (LAUNCHER: Cmd+Alt)
# ==============================================================================
# Sticky window (floating + pinned + always-on-top)
cmd + shift - s : $HOME/.local/bin/uke-sticky toggle
# Quick fix
cmd + shift - x : $HOME/.local/bin/uke-fix

cmd + alt - b : $HOME/.local/bin/uke-launch brave
cmd + alt - o : $HOME/.local/bin/uke-launch obsidian
cmd + alt - c : $HOME/.local/bin/uke-launch code
cmd + alt - r : $HOME/.local/bin/uke-launch raindrop
cmd + alt - t : $HOME/.local/bin/uke-launch wezterm

STATIC_BINDINGS

        # Generate bunches from registry.yaml
        echo "# =============================================================================="
        echo "# Bunches (Generated from registry.yaml)"
        echo "# =============================================================================="
        
        if check_yq; then
            local bunch_num=1
            for bunch_name in $(reg_keys ".bunches"); do
                echo "cmd + ctrl - $bunch_num : \$HOME/.local/bin/uke-bunch $bunch_name"
                ((bunch_num++))
                [[ $bunch_num -gt 5 ]] && break
            done
        else
            cat << 'STATIC_BUNCHES'
cmd + ctrl - 1 : $HOME/.local/bin/uke-bunch study
cmd + ctrl - 2 : $HOME/.local/bin/uke-bunch guitar
cmd + ctrl - 3 : $HOME/.local/bin/uke-bunch coding
cmd + ctrl - 4 : $HOME/.local/bin/uke-bunch email
cmd + ctrl - 5 : $HOME/.local/bin/uke-bunch reading
STATIC_BUNCHES
        fi
        
        cat << 'SESSION_BINDINGS'

# ==============================================================================
# Session Management
# ==============================================================================
cmd + ctrl - s : $HOME/.local/bin/uke-session save quick
cmd + ctrl + shift - s : $HOME/.local/bin/uke-session restore quick
SESSION_BINDINGS

    } > "$out"
    
    chmod +x "$out"
    ok "Generated: $out"
}

# ==============================================================================
# Generate yabai config (macOS)
# ==============================================================================
gen_yabai() {
    local out="$UKE_GEN/yabai/yabairc"
    mkdir -p "$(dirname "$out")"
    
    log_info "Generating yabai config..."
    
    {
        gen_header "sh" "YABAI CONFIG - Window Manager (macOS)"
        
        cat << EOF
#!/usr/bin/env sh

# Load Scripting Addition
sudo yabai --load-sa

# ==============================================================================
# Layout Configuration
# ==============================================================================
yabai -m config layout bsp
yabai -m config window_placement second_child
yabai -m config top_padding    4
yabai -m config bottom_padding 4
yabai -m config left_padding   4
yabai -m config right_padding  4
yabai -m config window_gap     4

# ==============================================================================
# Mouse Configuration
# ==============================================================================
yabai -m config mouse_follows_focus off
yabai -m config focus_follows_mouse off
yabai -m config mouse_modifier alt
yabai -m config mouse_action1 move
yabai -m config mouse_action2 resize

# ==============================================================================
# Window Behavior
# ==============================================================================
yabai -m config split_ratio 0.50
yabai -m config auto_balance off

# ==============================================================================
# Window Borders (Nord colorscheme)
# ==============================================================================
pkill -x borders 2>/dev/null || true
borders width=3 active_color=0xff${COLOR_BORDER_ACTIVE} inactive_color=0xff${COLOR_BORDER_INACTIVE} &

# ==============================================================================
# Terminal Opacity
# ==============================================================================
yabai -m config window_opacity off
yabai -m rule --add app="^WezTerm\$" opacity=0.92
yabai -m rule --add app="^Alacritty\$" opacity=0.92

EOF

        # Generate float rules from registry.yaml
        echo "# =============================================================================="
        echo "# Float Rules (Generated from registry.yaml)"
        echo "# =============================================================================="
        
        if check_yq; then
            for rule in $(reg_array ".float_rules"); do
                echo "yabai -m rule --add app=\"^${rule}\$\" manage=off"
            done
            echo ""
            
            # Generate window rules
            echo "# =============================================================================="
            echo "# Window Rules (Generated from registry.yaml)"
            echo "# =============================================================================="
            # Read window_rules array - this is more complex, use static for now
        fi
        
        cat << 'STATIC_RULES'
yabai -m rule --add app="^System Settings$" manage=off
yabai -m rule --add app="^Calculator$" manage=off sticky=on
yabai -m rule --add app="^Finder$" manage=off
yabai -m rule --add app="^App Store$" manage=off
yabai -m rule --add app="^Karabiner-Elements$" manage=off
yabai -m rule --add app="^Karabiner-EventViewer$" manage=off
yabai -m rule --add app="^zoom.us$" manage=off sticky=on opacity=1.0
yabai -m rule --add app="^FaceTime$" manage=off sticky=on
yabai -m rule --add title="Picture in Picture" manage=off sticky=on layer=above
yabai -m rule --add app="^Code$" title="Settings" manage=off
yabai -m rule --add title="Preferences" manage=off
yabai -m rule --add title="Settings" manage=off
STATIC_RULES

        echo ""
        echo "# =============================================================================="
        echo "# Workspace Assignments (Generated from registry.yaml)"
        echo "# =============================================================================="
        
        if check_yq; then
            for ws in $(reg_keys ".workspaces"); do
                for app in $(reg_array ".workspaces.${ws}.apps"); do
                    local app_name
                    app_name=$(get_app_name "$app")
                    [[ -n "$app_name" ]] && echo "yabai -m rule --add app=\"^${app_name}\$\" space=^${ws}"
                done
            done
        else
            cat << 'STATIC_WS'
yabai -m rule --add app="^Safari$" space=^1
yabai -m rule --add app="^Brave Browser$" space=^1
yabai -m rule --add app="^Obsidian$" space=^2
yabai -m rule --add app="^WezTerm$" space=^3
yabai -m rule --add app="^Code$" space=^3
yabai -m rule --add app="^Xcode$" space=^3
yabai -m rule --add app="^Preview$" space=^5
yabai -m rule --add app="^PDF Expert$" space=^5
yabai -m rule --add app="^Raindrop.io$" space=^6
yabai -m rule --add app="^Spotify$" space=^7
yabai -m rule --add app="^Microsoft Word$" space=^8
yabai -m rule --add app="^Microsoft Excel$" space=^8
yabai -m rule --add app="^Microsoft PowerPoint$" space=^8
yabai -m rule --add app="^Slack$" space=^9
yabai -m rule --add app="^Discord$" space=^9
yabai -m rule --add app="^Mail$" space=^9
yabai -m rule --add app="^Claude$" space=^10
yabai -m rule --add app="^Perplexity$" space=^10
STATIC_WS
        fi
        
        cat << 'HARDWARE_INCLUDE'

# ==============================================================================
# HARDWARE SPECIFIC INCLUDES (Ghost Files)
# ==============================================================================
# Loads GPU/Monitor/Form Factor settings generated by: uke profile
# These settings override defaults based on machine.profile
HARDWARE_CONF="$HOME/.config/yabai/generated_hardware.conf"
if [[ -f "$HARDWARE_CONF" ]]; then
    source "$HARDWARE_CONF"
fi

echo "yabai: Configuration loaded"
HARDWARE_INCLUDE

    } > "$out"
    
    chmod +x "$out"
    ok "Generated: $out"
}

# ==============================================================================
# Generate Hyprland config (Linux)
# ==============================================================================


gen_hyprland() {
    local out="$UKE_GEN/hyprland/hyprland.conf"
    mkdir -p "$(dirname "$out")"
    
    log_info "Generating Hyprland config (RECOVERY MODE)..."
    
    {
        gen_header "conf" "HYPRLAND CONFIG - Window Manager (Linux)"
        
        # 1. CORE SETTINGS (Quoted Heredoc - Variables are safe here)
        cat << 'HYPRLAND_CORE'
monitor=,preferred,auto,1

general {
    gaps_in = 2
    gaps_out = 4
    border_size = 2
    col.active_border = rgba(88c0d0ff)
    col.inactive_border = rgba(3b4252ff)
    layout = dwindle
    resize_on_border = true
}

decoration {
    rounding = 4
    blur {
        enabled = true
        size = 6
        passes = 2
    }
    shadow {
        enabled = true
        range = 8
        color = rgba(1a1a1aee)
    }
}

animations {
    enabled = true
    bezier = easeOutQuint, 0.22, 1, 0.36, 1
    animation = windows, 1, 4, easeOutQuint, slide
    animation = border, 1, 10, default
    animation = fade, 1, 5, default
    animation = workspaces, 1, 4, easeOutQuint, slide
}

input {
    kb_layout = us
    follow_mouse = 1
    touchpad {
        natural_scroll = true
    }
}

# GESTURES (Disabled for stability)
gestures {
    workspace_swipe = false
}
HYPRLAND_CORE

        # 2. KEYBINDINGS (Unquoted Heredoc - Variables expanded)
        # CRITICAL FIX: We use \$mainMod to escape the variable for Bash!
        
        local MOD="${UKE_MAIN_MOD:-Super}"
        
        cat << KEYBINDS

# Define the mod key variable for Hyprland
\$mainMod = $MOD

# App shortcuts
bind = \$mainMod, return, exec, wezterm
bind = \$mainMod, q, killactive
bind = \$mainMod, e, exit
bind = \$mainMod, f, togglefloating
bind = \$mainMod, p, pseudo
bind = \$mainMod, j, togglesplit

# Vim-style focus movement
bind = \$mainMod, h, movefocus, l
bind = \$mainMod, j, movefocus, d
bind = \$mainMod, k, movefocus, u
bind = \$mainMod, l, movefocus, r

# Workspaces 1-9
bind = \$mainMod, 1, workspace, 1
bind = \$mainMod, 2, workspace, 2
bind = \$mainMod, 3, workspace, 3
bind = \$mainMod, 4, workspace, 4
bind = \$mainMod, 5, workspace, 5
bind = \$mainMod, 6, workspace, 6
bind = \$mainMod, 7, workspace, 7
bind = \$mainMod, 8, workspace, 8
bind = \$mainMod, 9, workspace, 9

# Move active window to workspace
bind = \$mainMod SHIFT, 1, movetoworkspace, 1
bind = \$mainMod SHIFT, 2, movetoworkspace, 2
bind = \$mainMod SHIFT, 3, movetoworkspace, 3
bind = \$mainMod SHIFT, 4, movetoworkspace, 4
bind = \$mainMod SHIFT, 5, movetoworkspace, 5
bind = \$mainMod SHIFT, 6, movetoworkspace, 6
bind = \$mainMod SHIFT, 7, movetoworkspace, 7
bind = \$mainMod SHIFT, 8, movetoworkspace, 8
bind = \$mainMod SHIFT, 9, movetoworkspace, 9

KEYBINDS

        # 3. RULES & HARDWARE
        cat << 'WINDOWRULES'
windowrulev2 = workspace 1, class:^(brave-browser|firefox|chromium)$
windowrulev2 = workspace 3, class:^(wezterm|code|Code|Alacritty|kitty)$

# Load hardware specific settings (monitors, etc)
source = ~/.config/hypr/generated_hardware.conf
WINDOWRULES

    } > "$out"
    
    chmod 644 "$out"
    log_info "âœ“ Hyprland config generated (RECOVERY MODE)"
}





# ==============================================================================
# Generate uke-gather script
# ==============================================================================
gen_gather() {
    local out="$UKE_BIN/uke-gather"
    mkdir -p "$(dirname "$out")"
    
    log_info "Generating uke-gather..."
    
    {
        gen_header "sh" "UKE Gather - Organize windows by workspace"
        
        cat << 'EOF'
#!/usr/bin/env bash
set -euo pipefail

SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do
  DIR="$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE"
done
SCRIPT_DIR="$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"
export UKE_ROOT="${SCRIPT_DIR%/bin}"

source "$UKE_ROOT/lib/core.sh"
require_cmd jq

gather_macos() {
    local current_space
    current_space=$(yabai -m query --spaces --space | jq -r '.index')
    log_info "Gathering windows for space $current_space..."
    
    case $current_space in
        1)
            yabai -m query --windows | jq -r '.[] | select(.app == "Safari" or .app == "Brave Browser" or .app == "Firefox") | .id' | \
                xargs -I {} yabai -m window {} --space 1 2>/dev/null || true
            ;;
        2)
            yabai -m query --windows | jq -r '.[] | select(.app == "Obsidian") | .id' | \
                xargs -I {} yabai -m window {} --space 2 2>/dev/null || true
            ;;
        3)
            yabai -m query --windows | jq -r '.[] | select(.app == "WezTerm" or .app == "Code" or .app == "Xcode" or .app == "Cursor") | .id' | \
                xargs -I {} yabai -m window {} --space 3 2>/dev/null || true
            ;;
        5)
            yabai -m query --windows | jq -r '.[] | select(.app == "Preview" or .app == "PDF Expert") | .id' | \
                xargs -I {} yabai -m window {} --space 5 2>/dev/null || true
            ;;
        6)
            yabai -m query --windows | jq -r '.[] | select(.app == "Raindrop.io") | .id' | \
                xargs -I {} yabai -m window {} --space 6 2>/dev/null || true
            ;;
        7)
            yabai -m query --windows | jq -r '.[] | select(.app == "Spotify") | .id' | \
                xargs -I {} yabai -m window {} --space 7 2>/dev/null || true
            ;;
        8)
            yabai -m query --windows | jq -r '.[] | select(.app == "Microsoft Word" or .app == "Microsoft Excel" or .app == "Microsoft PowerPoint") | .id' | \
                xargs -I {} yabai -m window {} --space 8 2>/dev/null || true
            ;;
        9)
            yabai -m query --windows | jq -r '.[] | select(.app == "Slack" or .app == "Discord" or .app == "Mail") | .id' | \
                xargs -I {} yabai -m window {} --space 9 2>/dev/null || true
            ;;
        10)
            yabai -m query --windows | jq -r '.[] | select(.app == "Claude" or .app == "Perplexity") | .id' | \
                xargs -I {} yabai -m window {} --space 10 2>/dev/null || true
            ;;
        *)
            log_info "No gather action for space $current_space"
            ;;
    esac
    ok "Windows gathered"
}

gather_linux() {
    local current_ws
    current_ws=$(hyprctl activeworkspace -j | jq -r '.id')
    log_info "Gathering windows for workspace $current_ws..."
    
    case $current_ws in
        1)
            hyprctl clients -j | jq -r '.[] | select(.class | test("brave|firefox|chromium"; "i")) | .address' | \
                while read -r addr; do hyprctl dispatch movetoworkspacesilent "1,address:$addr" 2>/dev/null; done
            ;;
        2)
            hyprctl clients -j | jq -r '.[] | select(.class | test("obsidian"; "i")) | .address' | \
                while read -r addr; do hyprctl dispatch movetoworkspacesilent "2,address:$addr" 2>/dev/null; done
            ;;
        3)
            hyprctl clients -j | jq -r '.[] | select(.class | test("wezterm|code|alacritty|kitty"; "i")) | .address' | \
                while read -r addr; do hyprctl dispatch movetoworkspacesilent "3,address:$addr" 2>/dev/null; done
            ;;
        5)
            hyprctl clients -j | jq -r '.[] | select(.class | test("evince|zathura|okular"; "i")) | .address' | \
                while read -r addr; do hyprctl dispatch movetoworkspacesilent "5,address:$addr" 2>/dev/null; done
            ;;
        6)
            hyprctl clients -j | jq -r '.[] | select(.class | test("raindrop"; "i")) | .address' | \
                while read -r addr; do hyprctl dispatch movetoworkspacesilent "6,address:$addr" 2>/dev/null; done
            ;;
        7)
            hyprctl clients -j | jq -r '.[] | select(.class | test("spotify"; "i")) | .address' | \
                while read -r addr; do hyprctl dispatch movetoworkspacesilent "7,address:$addr" 2>/dev/null; done
            ;;
        8)
            hyprctl clients -j | jq -r '.[] | select(.class | test("libreoffice|soffice"; "i")) | .address' | \
                while read -r addr; do hyprctl dispatch movetoworkspacesilent "8,address:$addr" 2>/dev/null; done
            ;;
        9)
            hyprctl clients -j | jq -r '.[] | select(.class | test("slack|discord|thunderbird|telegram"; "i")) | .address' | \
                while read -r addr; do hyprctl dispatch movetoworkspacesilent "9,address:$addr" 2>/dev/null; done
            ;;
        10)
            hyprctl clients -j | jq -r '.[] | select(.class | test("claude"; "i")) | .address' | \
                while read -r addr; do hyprctl dispatch movetoworkspacesilent "10,address:$addr" 2>/dev/null; done
            ;;
        *)
            log_info "No gather action for workspace $current_ws"
            ;;
    esac
    ok "Windows gathered"
}

is_macos && gather_macos || gather_linux
EOF

    } > "$out"
    
    chmod +x "$out"
    ok "Generated: $out"
}

# ==============================================================================
# Main
# ==============================================================================
gen_all() {
    log_info "Generating all configs..."
    ensure_registry
    
    if is_macos; then
        gen_skhd
        gen_yabai
    else
        gen_hyprland
    fi
    gen_gather
    
    echo ""
    ok "All configs generated"
    echo ""
    
    # Check if hardware profile exists
    if ! has_profile; then
        warn "No hardware profile found!"
        info "Run 'uke profile' to configure machine-specific settings"
        info "Then run 'uke apply' to generate hardware configs"
    fi
}

case "${1:-all}" in
    skhd)     ensure_registry; gen_skhd ;;
    yabai)    ensure_registry; gen_yabai ;;
    hyprland) ensure_registry; gen_hyprland ;;
    gather)   gen_gather ;;
    all)      gen_all ;;
    *)        log_fatal "Unknown target: $1. Use: skhd|yabai|hyprland|gather|all" ;;
esac
