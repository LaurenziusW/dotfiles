#!/usr/bin/env bash
# ==============================================================================
# UKE Bunch - Environment Preset Runner
# ==============================================================================
# Runs a "bunch" - a preset environment that launches specific apps.
#
# Usage: uke-bunch <n>
# Example: uke-bunch coding
# ==============================================================================
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
export UKE_ROOT="${SCRIPT_DIR%/bin}"

source "$UKE_ROOT/lib/core.sh"

BUNCH_NAME="${1:-}"
BUNCH_DIR="$UKE_ROOT/bunches"

# ==============================================================================
# List Available Bunches
# ==============================================================================
list_bunches() {
    echo "Available bunches:"
    for f in "$BUNCH_DIR"/*.sh; do
        [[ -f "$f" ]] || continue
        local name
        name=$(basename "$f" .sh)
        [[ "$name" == "lib-os-detect" ]] && continue
        
        # Try to extract description
        local desc
        desc=$(grep -m1 "^# BUNCH:" "$f" 2>/dev/null | sed 's/# BUNCH: [^-]*- //' || echo "")
        printf "  %-12s %s\n" "$name" "$desc"
    done
}

# ==============================================================================
# Run Bunch
# ==============================================================================
run_bunch() {
    local name="$1"
    local script="$BUNCH_DIR/${name}.sh"
    
    if [[ ! -f "$script" ]]; then
        log_error "Bunch not found: $name"
        echo ""
        list_bunches
        exit 1
    fi
    
    log_info "Running bunch: $name"
    bash "$script"
}

# ==============================================================================
# Main
# ==============================================================================
if [[ -z "$BUNCH_NAME" ]]; then
    list_bunches
    exit 0
fi

case "$BUNCH_NAME" in
    list|--list|-l)
        list_bunches
        ;;
    help|--help|-h)
        echo "Usage: uke-bunch <name>"
        echo ""
        list_bunches
        ;;
    *)
        run_bunch "$BUNCH_NAME"
        ;;
esac
