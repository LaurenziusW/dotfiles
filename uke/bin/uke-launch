#!/usr/bin/env bash
# ==============================================================================
# UKE Launch - Smart App Launcher
# ==============================================================================
# Launches an app by nickname, handling platform differences.
# If the app is already running, focuses it instead.
#
# Usage: uke-launch <app-name>
# Example: uke-launch brave
# ==============================================================================
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
export UKE_ROOT="${SCRIPT_DIR%/bin}"

source "$UKE_ROOT/lib/core.sh"

APP="${1:-}"

if [[ -z "$APP" ]]; then
    log_fatal "Usage: uke-launch <app-name>"
fi

# ==============================================================================
# App Name Resolution
# ==============================================================================
get_app_name() {
    local key="$1"
    
    case "$key" in
        # Browsers
        brave)       is_macos && echo "Brave Browser" || echo "brave" ;;
        safari)      is_macos && echo "Safari" || echo "" ;;
        firefox)     echo "firefox" ;;
        chrome)      is_macos && echo "Google Chrome" || echo "google-chrome-stable" ;;
        
        # Notes
        obsidian)    is_macos && echo "Obsidian" || echo "obsidian" ;;
        notion)      is_macos && echo "Notion" || echo "notion-app" ;;
        
        # Development
        wezterm)     is_macos && echo "WezTerm" || echo "wezterm" ;;
        alacritty)   echo "Alacritty" ;;
        kitty)       echo "kitty" ;;
        code)        is_macos && echo "Visual Studio Code" || echo "code" ;;
        cursor)      is_macos && echo "Cursor" || echo "cursor" ;;
        
        # Media
        spotify)     is_macos && echo "Spotify" || echo "spotify" ;;
        
        # Communication
        slack)       is_macos && echo "Slack" || echo "slack" ;;
        discord)     is_macos && echo "Discord" || echo "discord" ;;
        
        # Documents
        preview)     is_macos && echo "Preview" || echo "evince" ;;
        zathura)     echo "zathura" ;;
        
        # Bookmarks
        raindrop)    is_macos && echo "Raindrop.io" || echo "raindrop" ;;
        
        # Default: use as-is
        *)           echo "$key" ;;
    esac
}

# ==============================================================================
# Check if App is Running
# ==============================================================================
app_running() {
    local name="$1"
    
    if is_macos; then
        pgrep -x "$name" &>/dev/null || osascript -e "tell application \"System Events\" to (name of processes) contains \"$name\"" 2>/dev/null | grep -q "true"
    else
        pgrep -i "${name,,}" &>/dev/null
    fi
}

# ==============================================================================
# Focus Existing Window
# ==============================================================================
focus_app() {
    local name="$1"
    
    if is_macos; then
        osascript -e "tell application \"$name\" to activate" 2>/dev/null
    else
        # Find window and focus it
        local addr
        addr=$(hyprctl clients -j | jq -r ".[] | select(.class | test(\"$name\"; \"i\")) | .address" | head -1)
        if [[ -n "$addr" ]]; then
            hyprctl dispatch focuswindow "address:$addr" 2>/dev/null
        fi
    fi
}

# ==============================================================================
# Launch App
# ==============================================================================
launch_app() {
    local name="$1"
    
    if is_macos; then
        open -a "$name" &>/dev/null &
    else
        local cmd="${name,,}"
        if command -v "$cmd" &>/dev/null; then
            "$cmd" &>/dev/null &
        elif command -v "$name" &>/dev/null; then
            "$name" &>/dev/null &
        else
            log_fatal "Cannot launch: $name (command not found)"
        fi
    fi
}

# ==============================================================================
# Main
# ==============================================================================
APP_NAME=$(get_app_name "$APP")

if [[ -z "$APP_NAME" ]]; then
    log_fatal "App '$APP' is not available on $UKE_OS"
fi

if app_running "$APP_NAME"; then
    log_info "Focusing: $APP_NAME"
    focus_app "$APP_NAME"
else
    log_info "Launching: $APP_NAME"
    launch_app "$APP_NAME"
fi
