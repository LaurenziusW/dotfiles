#!/usr/bin/env bash
# ==============================================================================
# UKE Launch - Smart App Launcher
# ==============================================================================
# Opens apps AND switches to their designated workspace
# Usage: uke-launch <app>
# ==============================================================================
set -euo pipefail

SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do
  DIR="$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE"
done
SCRIPT_DIR="$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"
export UKE_ROOT="${SCRIPT_DIR%/bin}"
source "$UKE_ROOT/lib/core.sh"

# ==============================================================================
# App → Workspace Mapping
# ==============================================================================
declare -A APP_WORKSPACE=(
    # Workspace 1: Browser
    [brave]=1 [safari]=1 [firefox]=1 [chromium]=1 [chrome]=1
    # Workspace 2: Notes
    [obsidian]=2 [notion]=2 [bear]=2
    # Workspace 3: Code
    [wezterm]=3 [terminal]=3 [alacritty]=3 [kitty]=3
    [code]=3 [vscode]=3 [codium]=3 [xcode]=3 [cursor]=3
    [intellij]=3 [webstorm]=3 [pycharm]=3
    # Workspace 4: Catch-all (no assignment)
    # Workspace 5: Documents
    [preview]=5 [evince]=5 [zathura]=5 [okular]=5 [pdf]=5
    # Workspace 6: Raindrop
    [raindrop]=6
    # Workspace 7: Media
    [spotify]=7 [music]=7 [apple-music]=7
    # Workspace 8: Office
    [word]=8 [excel]=8 [powerpoint]=8 [libreoffice]=8 [pages]=8 [numbers]=8 [keynote]=8
    # Workspace 9: Communication
    [slack]=9 [discord]=9 [mail]=9 [thunderbird]=9 [telegram]=9 [whatsapp]=9 [messages]=9 [teams]=9
    # Workspace 10: AI
    [claude]=10 [perplexity]=10 [chatgpt]=10
)

# ==============================================================================
# App Name → Launch Command
# ==============================================================================
get_launch_cmd() {
    local app="$1"
    
    if is_macos; then
        case "$app" in
            brave)       echo "open -a 'Brave Browser'" ;;
            safari)      echo "open -a Safari" ;;
            firefox)     echo "open -a Firefox" ;;
            chrome)      echo "open -a 'Google Chrome'" ;;
            obsidian)    echo "open -a Obsidian" ;;
            notion)      echo "open -a Notion" ;;
            wezterm)     echo "open -a WezTerm" ;;
            terminal)    echo "open -a Terminal" ;;
            alacritty)   echo "open -a Alacritty" ;;
            code)        echo "open -a 'Visual Studio Code'" ;;
            xcode)       echo "open -a Xcode" ;;
            cursor)      echo "open -a Cursor" ;;
            preview)     echo "open -a Preview" ;;
            spotify)     echo "open -a Spotify" ;;
            music)       echo "open -a Music" ;;
            word)        echo "open -a 'Microsoft Word'" ;;
            excel)       echo "open -a 'Microsoft Excel'" ;;
            powerpoint)  echo "open -a 'Microsoft PowerPoint'" ;;
            pages)       echo "open -a Pages" ;;
            numbers)     echo "open -a Numbers" ;;
            keynote)     echo "open -a Keynote" ;;
            slack)       echo "open -a Slack" ;;
            discord)     echo "open -a Discord" ;;
            mail)        echo "open -a Mail" ;;
            telegram)    echo "open -a Telegram" ;;
            whatsapp)    echo "open -a WhatsApp" ;;
            messages)    echo "open -a Messages" ;;
            teams)       echo "open -a 'Microsoft Teams'" ;;
            raindrop)    echo "open -a Raindrop.io" ;;
            claude)      echo "open -a Claude" ;;
            perplexity)  echo "open -a Perplexity" ;;
            *)           echo "open -a '$app'" ;;
        esac
    else
        case "$app" in
            brave)       echo "brave" ;;
            firefox)     echo "firefox" ;;
            chromium)    echo "chromium" ;;
            chrome)      echo "google-chrome-stable" ;;
            obsidian)    echo "obsidian" ;;
            notion)      echo "notion-app" ;;
            wezterm)     echo "wezterm" ;;
            terminal)    echo "wezterm" ;;
            alacritty)   echo "alacritty" ;;
            kitty)       echo "kitty" ;;
            code)        echo "code" ;;
            codium)      echo "codium" ;;
            cursor)      echo "cursor" ;;
            evince)      echo "evince" ;;
            zathura)     echo "zathura" ;;
            okular)      echo "okular" ;;
            spotify)     echo "spotify" ;;
            libreoffice) echo "libreoffice" ;;
            word)        echo "libreoffice --writer" ;;
            excel)       echo "libreoffice --calc" ;;
            powerpoint)  echo "libreoffice --impress" ;;
            slack)       echo "slack" ;;
            discord)     echo "discord" ;;
            thunderbird) echo "thunderbird" ;;
            mail)        echo "thunderbird" ;;
            telegram)    echo "telegram-desktop" ;;
            signal)      echo "signal-desktop" ;;
            raindrop)    echo "raindrop" ;;
            claude)      echo "claude" ;;
            *)           echo "$app" ;;
        esac
    fi
}

# ==============================================================================
# Switch Workspace
# ==============================================================================
switch_workspace() {
    local ws="$1"
    if is_macos; then
        yabai -m space --focus "$ws" 2>/dev/null || true
    else
        hyprctl dispatch workspace "$ws" 2>/dev/null || true
    fi
}

# ==============================================================================
# Launch App
# ==============================================================================
launch_app() {
    local app="$1"
    local workspace="${APP_WORKSPACE[$app]:-}"
    local cmd=$(get_launch_cmd "$app")
    
    # Switch to workspace first (if assigned)
    if [[ -n "$workspace" ]]; then
        log_info "Switching to workspace $workspace..."
        switch_workspace "$workspace"
        sleep 0.1
    fi
    
    # Launch the app
    log_info "Launching $app..."
    if is_macos; then
        eval "$cmd"
    else
        # Launch in background, detached
        nohup $cmd >/dev/null 2>&1 &
        disown
    fi
    
    ok "Launched $app" ${workspace:+"→ workspace $workspace"}
}

# ==============================================================================
# List Apps
# ==============================================================================
list_apps() {
    echo "Available apps with workspace assignments:"
    echo ""
    printf "%-15s %s\n" "APP" "WORKSPACE"
    printf "%-15s %s\n" "---" "---------"
    
    # Sort by workspace
    for app in $(echo "${!APP_WORKSPACE[@]}" | tr ' ' '\n' | sort); do
        printf "%-15s %s\n" "$app" "${APP_WORKSPACE[$app]}"
    done
}

# ==============================================================================
# Main
# ==============================================================================
case "${1:-}" in
    ""|list|ls|-l)
        list_apps
        ;;
    -h|--help|help)
        cat << 'EOF'
UKE Launch - Smart App Launcher

Usage:
  uke-launch <app>     Launch app and switch to its workspace
  uke-launch list      List all apps and their workspaces

Examples:
  uke-launch brave     → Opens Brave and switches to WS 1
  uke-launch obsidian  → Opens Obsidian and switches to WS 2
  uke-launch code      → Opens VS Code and switches to WS 3
EOF
        ;;
    *)
        launch_app "$1"
        ;;
esac
