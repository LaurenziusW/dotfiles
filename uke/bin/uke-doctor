#!/usr/bin/env bash
# ==============================================================================
# UKE Doctor - Health check
# ==============================================================================
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
export UKE_ROOT="${SCRIPT_DIR%/bin}"
source "$UKE_ROOT/lib/core.sh"

check_deps() {
    local status=0
    echo "Checking dependencies..."
    
    for cmd in stow jq git; do
        if command -v $cmd &>/dev/null; then
            ok "$cmd installed"
        else
            fail "$cmd not found"
            status=1
        fi
    done
    
    if is_macos; then
        for cmd in yabai skhd; do
            if command -v $cmd &>/dev/null; then
                ok "$cmd installed"
            else
                fail "$cmd not found"
                status=1
            fi
        done
        
        if command -v borders &>/dev/null; then
            ok "borders installed"
        else
            log_warn "borders not found (optional, for window borders)"
        fi
    else
        if command -v hyprctl &>/dev/null; then
            ok "hyprland installed"
        else
            fail "hyprland not found"
            status=1
        fi
    fi
    
    return $status
}

check_configs() {
    local status=0
    echo ""
    echo "Checking configurations..."
    
    [[ -f "$UKE_CONFIG/registry.yaml" ]] && ok "registry.yaml exists" || { fail "registry.yaml missing"; status=1; }
    
    if is_macos; then
        [[ -f "$UKE_GEN/skhd/skhdrc" ]] && ok "skhd config generated" || { fail "skhd config missing - run 'uke gen'"; status=1; }
        [[ -f "$UKE_GEN/yabai/yabairc" ]] && ok "yabai config generated" || { fail "yabai config missing - run 'uke gen'"; status=1; }
    else
        [[ -f "$UKE_GEN/hyprland/hyprland.conf" ]] && ok "hyprland config generated" || { fail "hyprland config missing - run 'uke gen'"; status=1; }
    fi
    
    return $status
}

check_links() {
    local status=0
    echo ""
    echo "Checking symlinks..."
    
    for bin in uke uke-bunch uke-gather uke-logs uke-scratchpad uke-session; do
        if [[ -x "$HOME/.local/bin/$bin" ]]; then
            ok "$bin linked"
        else
            fail "$bin not in ~/.local/bin"
            status=1
        fi
    done
    
    return $status
}

check_services() {
    echo ""
    echo "Checking services..."
    
    if is_macos; then
        if pgrep -q yabai; then
            ok "yabai running"
        else
            fail "yabai not running"
        fi
        
        if pgrep -q skhd; then
            ok "skhd running"
        else
            fail "skhd not running"
        fi
    else
        if [[ -n "${HYPRLAND_INSTANCE_SIGNATURE:-}" ]]; then
            ok "hyprland running"
        else
            fail "hyprland not running"
        fi
    fi
}

main() {
    echo "╔══════════════════════════════════════╗"
    echo "║     UKE Doctor - Health Check        ║"
    echo "╚══════════════════════════════════════╝"
    echo ""
    echo "Platform: $UKE_OS"
    echo "UKE Root: $UKE_ROOT"
    echo ""
    
    local overall=0
    
    check_deps || overall=1
    check_configs || overall=1
    check_links || overall=1
    check_services
    
    echo ""
    if [[ $overall -eq 0 ]]; then
        echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
        ok "All checks passed!"
    else
        echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
        fail "Some checks failed - see above"
    fi
    
    return $overall
}

main "$@"
