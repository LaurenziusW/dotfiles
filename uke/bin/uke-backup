#!/usr/bin/env bash
# ==============================================================================
# UKE Backup - Config backup utility
# ==============================================================================
set -euo pipefail

# Resolve symlink to find true source location
SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do
  DIR="$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE"
done
SCRIPT_DIR="$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"
export UKE_ROOT="${SCRIPT_DIR%/bin}"
source "$UKE_ROOT/lib/core.sh"

BACKUP_ROOT="$HOME/.uke-backups"

create_backup() {
    local timestamp=$(date +%Y%m%d-%H%M%S)
    local backup_dir="$BACKUP_ROOT/$timestamp"
    
    log_info "Creating backup: $backup_dir"
    mkdir -p "$backup_dir"
    
    # Backup registry
    cp "$UKE_CONFIG/registry.yaml" "$backup_dir/" && ok "Backed up registry.yaml"
    
    # Backup generated configs
    if is_macos; then
        [[ -f "$UKE_GEN/skhd/skhdrc" ]] && cp "$UKE_GEN/skhd/skhdrc" "$backup_dir/"
        [[ -f "$UKE_GEN/yabai/yabairc" ]] && cp "$UKE_GEN/yabai/yabairc" "$backup_dir/"
    else
        [[ -f "$UKE_GEN/hyprland/hyprland.conf" ]] && cp "$UKE_GEN/hyprland/hyprland.conf" "$backup_dir/"
    fi
    
    # Create manifest
    cat > "$backup_dir/MANIFEST.txt" << EOF
UKE Backup
Created: $(date)
Platform: $UKE_OS
Version: $UKE_VERSION

Files:
$(ls -1 "$backup_dir" | grep -v MANIFEST)
EOF
    
    ok "Backup complete: $backup_dir"
}

list_backups() {
    if [[ ! -d "$BACKUP_ROOT" ]]; then
        log_info "No backups found"
        return 0
    fi
    
    echo "Available backups:"
    for backup in "$BACKUP_ROOT"/*; do
        [[ -d "$backup" ]] || continue
        echo "  $(basename "$backup")"
    done
}

restore_backup() {
    local name="$1"
    local backup_dir="$BACKUP_ROOT/$name"
    
    [[ -d "$backup_dir" ]] || log_fatal "Backup not found: $name"
    
    log_warn "This will overwrite your current configs!"
    read -p "Continue? (y/N) " -n 1 -r
    echo
    [[ $REPLY =~ ^[Yy]$ ]] || { log_info "Aborted"; return 1; }
    
    [[ -f "$backup_dir/registry.yaml" ]] && {
        cp "$backup_dir/registry.yaml" "$UKE_CONFIG/"
        ok "Restored registry.yaml"
    }
    
    log_info "Run 'uke gen && uke reload' to apply"
}

case "${1:-}" in
    create|"") create_backup ;;
    list|ls)   list_backups ;;
    restore)   restore_backup "${2:-}" ;;
    *)         echo "Usage: uke-backup [create|list|restore <name>]" ;;
esac
