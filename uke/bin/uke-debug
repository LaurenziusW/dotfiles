#!/usr/bin/env bash
# ==============================================================================
# UKE Debug - Diagnostics
# ==============================================================================
set -euo pipefail

# Resolve symlink to find true source location
SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do
  DIR="$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE"
done
SCRIPT_DIR="$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"
export UKE_ROOT="${SCRIPT_DIR%/bin}"
source "$UKE_ROOT/lib/core.sh"
source "$UKE_ROOT/lib/wm.sh"

dump_system() {
    cat << EOF
╔══════════════════════════════════════════════════════════════════╗
║                    UKE Debug Report                               ║
╚══════════════════════════════════════════════════════════════════╝

Generated: $(date)

SYSTEM
──────
  OS:       $(uname -s) $(uname -r)
  Platform: $UKE_OS
  Shell:    $SHELL
  User:     $USER
  Home:     $HOME

UKE
────
  Version:  $UKE_VERSION
  Root:     $UKE_ROOT
  Config:   $UKE_CONFIG
  Gen:      $UKE_GEN

DEPENDENCIES
────────────
EOF

    for cmd in stow jq git yabai skhd hyprctl borders; do
        if command -v $cmd &>/dev/null; then
            printf "  ✓ %-12s %s\n" "$cmd:" "$(command -v $cmd)"
        else
            printf "  ✗ %-12s %s\n" "$cmd:" "not found"
        fi
    done

    cat << EOF

WINDOW MANAGER
──────────────
  Running:   $(wm_running && echo "yes" || echo "no")
  Workspace: $(wm_current_workspace 2>/dev/null || echo "unknown")

FILES
─────
  Registry: $(ls -lh "$UKE_CONFIG/registry.yaml" 2>/dev/null | awk '{print $5, $6, $7, $8}' || echo "missing")
EOF

    if is_macos; then
        echo "  skhdrc:   $(ls -lh "$UKE_GEN/skhd/skhdrc" 2>/dev/null | awk '{print $5, $6, $7, $8}' || echo "missing")"
        echo "  yabairc:  $(ls -lh "$UKE_GEN/yabai/yabairc" 2>/dev/null | awk '{print $5, $6, $7, $8}' || echo "missing")"
    else
        echo "  hyprland: $(ls -lh "$UKE_GEN/hyprland/hyprland.conf" 2>/dev/null | awk '{print $5, $6, $7, $8}' || echo "missing")"
    fi

    cat << EOF

RECENT LOGS
───────────
EOF
    tail -n 15 "$UKE_LOG_FILE" 2>/dev/null || echo "  No logs available"
    
    echo ""
    echo "═══════════════════════════════════════════════════════════════════"
}

trace_key() {
    local key="$1"
    log_info "Tracing keybinding: $key"
    
    echo ""
    echo "In generated skhd config:"
    grep -n "$key" "$UKE_GEN/skhd/skhdrc" 2>/dev/null || echo "  Not found"
}

case "${1:-dump}" in
    dump)  dump_system ;;
    trace) trace_key "${2:-h}" ;;
    *)     echo "Usage: uke-debug [dump|trace <key>]" ;;
esac
