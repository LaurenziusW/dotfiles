#!/usr/bin/env bash
# ==============================================================================
# UKE Scratchpad - Toggle dropdown/floating windows (FIXED)
# ==============================================================================
set -euo pipefail

# Resolve symlink to find true source location
SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do
  DIR="$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE"
done
SCRIPT_DIR="$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"
export UKE_ROOT="${SCRIPT_DIR%/bin}"
source "$UKE_ROOT/lib/core.sh"

SCRATCH_STATE="$UKE_STATE/scratchpads"
mkdir -p "$SCRATCH_STATE"

get_scratch_config() {
    local name="$1"
    local field="$2"
    yq -r ".scratchpads.${name}.${field} | select(. != null)" "$UKE_CONFIG/registry.yaml" 2>/dev/null
}

get_scratch_app() {
    local name="$1"
    local app_key=$(get_scratch_config "$name" "app")
    [[ -z "$app_key" ]] && return 1
    
    if is_macos; then
        yq -r ".apps.${app_key}.macos | select(. != null)" "$UKE_CONFIG/registry.yaml" 2>/dev/null
    else
        yq -r ".apps.${app_key}.linux | select(. != null)" "$UKE_CONFIG/registry.yaml" 2>/dev/null
    fi
}

scratchpad_macos() {
    local name="$1"
    local app_name=$(get_scratch_app "$name")
    
    [[ -z "$app_name" ]] && log_fatal "Unknown scratchpad: $name"
    
    local width=$(get_scratch_config "$name" "size.width")
    local height=$(get_scratch_config "$name" "size.height")
    local position=$(get_scratch_config "$name" "position")
    
    # Defaults
    width=${width:-80}
    height=${height:-40}
    position=${position:-top}
    
    local state_file="$SCRATCH_STATE/${name}.id"
    
    # Get display dimensions (using floor to fix arithmetic errors)
    local display_info=$(yabai -m query --displays --display)
    local display_w=$(echo "$display_info" | jq -r '.frame.w | floor')
    local display_h=$(echo "$display_info" | jq -r '.frame.h | floor')
    local display_x=$(echo "$display_info" | jq -r '.frame.x | floor')
    local display_y=$(echo "$display_info" | jq -r '.frame.y | floor')
    
    # Calculate window dimensions
    local win_w=$((display_w * width / 100))
    local win_h=$((display_h * height / 100))
    local win_x=$((display_x + (display_w - win_w) / 2))
    local win_y
    
    case "$position" in
        top)    win_y=$((display_y + 40)) ;;  # +40 for menu bar clearance
        bottom) win_y=$((display_y + display_h - win_h - 20)) ;;
        center) win_y=$((display_y + (display_h - win_h) / 2)) ;;
        *)      win_y=$((display_y + 40)) ;;
    esac
    
    local window_id=""
    
    # Check if we have a saved ID and if it is still valid
    if [[ -f "$state_file" ]]; then
        local saved_id=$(cat "$state_file")
        if yabai -m query --windows --window "$saved_id" &>/dev/null; then
            window_id="$saved_id"
        fi
    fi
    
    # If no valid saved ID, find the window by app name
    if [[ -z "$window_id" ]]; then
        window_id=$(yabai -m query --windows | jq -r ".[] | select(.app == \"$app_name\") | .id" | head -1)
    fi
    
    # If still no ID, launch the app
    if [[ -z "$window_id" || "$window_id" == "null" ]]; then
        log_info "Launching $app_name..."
        open -a "$app_name"
        
        # Wait for window to appear (up to 5 seconds)
        for i in {1..25}; do
            sleep 0.2
            window_id=$(yabai -m query --windows | jq -r ".[] | select(.app == \"$app_name\") | .id" | head -1)
            [[ -n "$window_id" && "$window_id" != "null" ]] && break
        done
        
        [[ -z "$window_id" ]] && log_fatal "Failed to launch $app_name"
    fi
    
    # Save the ID
    echo "$window_id" > "$state_file"

    # Toggle Logic
    local window_info=$(yabai -m query --windows --window "$window_id")
    local is_minimized=$(echo "$window_info" | jq -r '.["is-minimized"]')
    local is_hidden=$(echo "$window_info" | jq -r '.["is-hidden"]')
    local current_space=$(yabai -m query --spaces --space | jq -r '.index')
    local window_space=$(echo "$window_info" | jq -r '.space')
    local has_focus=$(echo "$window_info" | jq -r '.["has-focus"]')

    if [[ "$has_focus" == "true" ]]; then
        # If active, hide it (minimize is safest for "hiding" in standard macOS)
        yabai -m window "$window_id" --minimize
    else
        # SHOW IT
        # 1. Bring to current space (critical fix!)
        if [[ "$window_space" != "$current_space" ]]; then
            yabai -m window "$window_id" --space "$current_space"
        fi

        # 2. Deminimize if needed
        if [[ "$is_minimized" == "true" ]]; then
            yabai -m window "$window_id" --deminimize
        fi

        # 3. Force Float and Resize
        yabai -m window "$window_id" --grid off \
              --move abs:${win_x}:${win_y} \
              --resize abs:${win_w}:${win_h} \
              --toggle float --toggle float # Hack to ensure it's floating if tiled

        # 4. Focus
        yabai -m window "$window_id" --focus
    fi
}

scratchpad_linux() {
    log_warn "Linux scratchpad logic requires Hyprland special workspaces."
}

case "${1:-}" in
    ""|list|ls) list_scratchpads ;;
    *) is_macos && scratchpad_macos "$1" || scratchpad_linux "$1" ;;
esac