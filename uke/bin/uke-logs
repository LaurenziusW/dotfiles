#!/usr/bin/env bash
# ==============================================================================
# UKE Logs - Live log viewer for all components
# ==============================================================================
set -euo pipefail

# Resolve symlink to find true source location
SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do
  DIR="$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE"
done
SCRIPT_DIR="$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"
export UKE_ROOT="${SCRIPT_DIR%/bin}"
source "$UKE_ROOT/lib/core.sh"

show_help() {
    cat << 'EOF'
UKE Logs - Live log viewer

Usage: uke-logs [component]

Components:
  uke       UKE internal logs
  yabai     Yabai window manager (macOS)
  skhd      skhd hotkey daemon (macOS)
  hyprland  Hyprland compositor (Linux)
  all       All logs combined (requires multitail)

Examples:
  uke-logs uke          # Tail UKE logs
  uke-logs yabai        # Tail yabai logs
  uke-logs all          # Combined view
EOF
}

tail_log() {
    local name="$1" path="$2"
    [[ -f "$path" ]] || { echo "No $name log at $path"; return 1; }
    echo "Tailing: $path (Ctrl+C to stop)"
    echo "─────────────────────────────────────"
    tail -f "$path"
}

tail_all() {
    if command -v multitail &>/dev/null; then
        local logs=()
        [[ -f "$HOME/.local/state/uke/uke.log" ]] && logs+=("$HOME/.local/state/uke/uke.log")
        if is_macos; then
            local y=$(ls /tmp/yabai_*.err.log 2>/dev/null | head -1)
            local s=$(ls /tmp/skhd_*.err.log 2>/dev/null | head -1)
            [[ -f "$y" ]] && logs+=("$y")
            [[ -f "$s" ]] && logs+=("$s")
        else
            [[ -f "$HOME/.local/share/hyprland/hyprland.log" ]] && logs+=("$HOME/.local/share/hyprland/hyprland.log")
        fi
        multitail "${logs[@]}"
    else
        echo "Install 'multitail' for combined view:"
        echo "  macOS: brew install multitail"
        echo "  Linux: sudo pacman -S multitail"
        echo ""
        echo "Or tail individually: uke-logs uke|yabai|skhd|hyprland"
    fi
}

case "${1:-help}" in
    uke)      tail_log "UKE" "$HOME/.local/state/uke/uke.log" ;;
    yabai)    tail_log "yabai" "$(ls /tmp/yabai_*.err.log 2>/dev/null | head -1)" ;;
    skhd)     tail_log "skhd" "$(ls /tmp/skhd_*.err.log 2>/dev/null | head -1)" ;;
    hyprland) tail_log "Hyprland" "$HOME/.local/share/hyprland/hyprland.log" ;;
    all)      tail_all ;;
    help|--help|-h) show_help ;;
    *)        echo "Unknown: $1"; show_help; exit 1 ;;
esac
