#!/usr/bin/env bash

# Load OS detection
source "$(dirname "$0")/lib-os-detect"
OS_TYPE=$(detect_os)

# --- CONFIGURATION ---
# We define the list of "Known Apps" to exclude from Space 6
# This Regex includes all apps assigned to spaces 1, 2, 3, 4, 5, 7, 8, 9, 10
MACOS_KNOWN="^(Safari|Brave Browser|Arc|Obsidian|WezTerm|Code|Xcode|Finder|ForkLift|Preview|PDF Expert|Spotify|Slack|Discord|Mail|Telegram|Microsoft .*|Claude|Perplexity|GeminiAPP)$"
LINUX_KNOWN="^(Brave-browser|Safari|obsidian|org.wezfurlong.wezterm|Code|Xcode|org.gnome.Preview|Spotify|Slack|discord|org.telegram.desktop)$"

# --- macOS (Yabai) ---
if [ "$OS_TYPE" = "macos" ]; then
    CURRENT_SPACE=$(yabai -m query --spaces --space | jq '.index')
    echo "üçè macOS: Gathering apps for Space $CURRENT_SPACE..."

    pull_macos() {
        local target=$1
        local query=$2
        yabai -m query --windows | \
        jq -r ".[] | select(($query) and .[\"is-minimized\"] == false) | .id" | \
        while read -r id; do yabai -m window "$id" --space "$target"; done
    }

    case $CURRENT_SPACE in
        1) pull_macos 1 '.app == "Safari" or .app == "Brave Browser" or .app == "Arc"' ;;
        2) pull_macos 2 '.app == "Obsidian"' ;;
        3) pull_macos 3 '.app == "WezTerm" or .app == "Code" or .app == "Xcode"' ;;
        4) pull_macos 4 '.app == "Finder" or .app == "ForkLift"' ;;
        5) pull_macos 5 '.app == "Preview" or .app == "PDF Expert"' ;;
        
        # --- SPACE 6: CATCH-ALL (Everything NOT in the known list) ---
        6) pull_macos 6 ".app | test(\"$MACOS_KNOWN\") | not" ;;
        
        7) pull_macos 7 '.app == "Spotify"' ;;
        8) pull_macos 8 '.app == "Slack" or .app == "Discord" or .app == "Mail" or .app == "Telegram"' ;;
        9) pull_macos 9 '.app | test("Microsoft .*")' ;;
        10) pull_macos 10 '.app == "Claude" or .app == "Perplexity" or .app == "GeminiAPP"' ;;
        *) echo "‚ö†Ô∏è No specific apps assigned to Space $CURRENT_SPACE" ;;
    esac

# --- Linux (Hyprland) ---
elif [ "$OS_TYPE" = "linux" ]; then
    CURRENT_SPACE=$(hyprctl activeworkspace -j | jq '.id')
    echo "üêß Linux: Gathering apps for Workspace $CURRENT_SPACE..."

    move_linux() {
        local workspace=$1
        local query=$2
        hyprctl clients -j | jq -r ".[] | select($query) | .address" | while read -r addr; do
            hyprctl dispatch movetoworkspacesilent "$workspace,address:$addr"
        done
    }

    case $CURRENT_SPACE in
        1) move_linux 1 '.class == "Brave-browser" or .class == "Safari"' ;; 
        2) move_linux 2 '.class == "obsidian"' ;;
        3) move_linux 3 '.class == "org.wezfurlong.wezterm" or .class == "Code" or .class == "Xcode"' ;;
        5) move_linux 5 '.class == "org.gnome.Preview" or (.title | contains("PDF"))' ;;
        
        # --- SPACE 6: CATCH-ALL (Everything NOT in the known list) ---
        6) move_linux 6 ".class | test(\"$LINUX_KNOWN\") | not" ;;

        7) move_linux 7 '.class == "Spotify"' ;;
        8) move_linux 8 '.class | contains("Microsoft")' ;;
        9) move_linux 9 '.class == "Slack" or .class == "discord" or .class == "org.telegram.desktop"' ;;
        10) move_linux 10 '(.title | contains("Claude")) or (.title | contains("Perplexity"))' ;;
        *) echo "‚ö†Ô∏è No specific apps assigned to Workspace $CURRENT_SPACE" ;;
    esac
fi







