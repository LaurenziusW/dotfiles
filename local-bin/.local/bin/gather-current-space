#!/bin/bash

# ==============================================================================
#  GATHER CURRENT SPACE
#  Moves all windows from all other workspaces to the current one.
#  Supports: macOS (Yabai) & Arch Linux (Hyprland)
# ==============================================================================

# 1. OS DETECTION
# ------------------------------------------------------------------------------
detect_os() {
    if [[ "$OSTYPE" == "darwin"* ]]; then
        echo "macos"
    elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
        echo "linux"
    else
        echo "unknown"
    fi
}
OS=$(detect_os)

# 2. VERSION A: macOS (Yabai)
# ------------------------------------------------------------------------------
if [[ "$OS" == "macos" ]]; then
    # Check dependency
    if ! command -v yabai &> /dev/null; then 
        echo "‚ùå Error: yabai not found"
        exit 1
    fi
    
    # Get current Space Index
    CURRENT_SPACE=$(yabai -m query --spaces --space | jq '.index')
    echo "üçè macOS: Gathering windows to Space $CURRENT_SPACE..."
    
    # Logic: Query all windows -> Filter those NOT on current space -> Move them
    yabai -m query --windows | \
    jq -r ".[] | select(.space != $CURRENT_SPACE) | .id" | \
    xargs -I{} yabai -m window {} --space "$CURRENT_SPACE"

# 3. VERSION B: Arch Linux (Hyprland)
# ------------------------------------------------------------------------------
elif [[ "$OS" == "linux" ]]; then
    # Check dependency
    if ! command -v hyprctl &> /dev/null; then 
        echo "‚ùå Error: hyprctl not found"
        exit 1
    fi
    
    # Get active Workspace ID
    CURRENT_WS=$(hyprctl activeworkspace -j | jq '.id')
    echo "üêß Linux: Gathering windows to Workspace $CURRENT_WS..."
    
    # Logic: Get all clients -> Filter those NOT on current workspace -> Move them silently
    # We use 'address' to identify windows uniquely in Hyprland
    hyprctl clients -j | \
    jq -r ".[] | select(.workspace.id != $CURRENT_WS) | .address" | \
    while read -r addr; do
        hyprctl dispatch movetoworkspacesilent "$CURRENT_WS,address:$addr"
    done

else
    echo "‚ùå Unknown OS: $OSTYPE"
    exit 1
fi

echo "‚úÖ Done."
