#!/usr/bin/env bash
# ==============================================================================
# UKE Doctor - Health Check (Arch Linux Ready)
# ==============================================================================
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
export UKE_ROOT="${SCRIPT_DIR%/bin}"
source "$UKE_ROOT/lib/core.sh"

# ==============================================================================
# Dependency Check
# ==============================================================================
check_deps() {
    local status=0
    echo "Checking dependencies..."
    
    # Universal dependencies
    for cmd in stow jq git; do
        if command -v $cmd &>/dev/null; then
            ok "$cmd installed"
        else
            fail "$cmd not found"
            status=1
        fi
    done
    
    if is_macos; then
        # macOS-specific
        for cmd in yabai skhd; do
            if command -v $cmd &>/dev/null; then
                ok "$cmd installed"
            else
                fail "$cmd not found"
                status=1
            fi
        done
        
        if command -v borders &>/dev/null; then
            ok "borders installed"
        else
            log_warn "borders not found (optional, for window borders)"
        fi
        
        if command -v yq &>/dev/null; then
            ok "yq installed"
        else
            log_warn "yq not found (needed for config generation from registry.yaml)"
        fi
    else
        # Linux-specific
        if command -v hyprctl &>/dev/null; then
            ok "hyprland installed"
        else
            fail "hyprland not found"
            status=1
        fi
        
        if command -v keyd &>/dev/null; then
            ok "keyd installed"
        else
            log_warn "keyd not found (needed for Caps Lock remapping)"
        fi
        
        # Optional Hyprland ecosystem tools
        local optional_linux=(waybar dunst wofi grim slurp wl-copy)
        local missing_optional=()
        
        for cmd in "${optional_linux[@]}"; do
            if ! command -v $cmd &>/dev/null; then
                missing_optional+=("$cmd")
            fi
        done
        
        if [[ ${#missing_optional[@]} -gt 0 ]]; then
            log_warn "Optional tools not found: ${missing_optional[*]}"
            echo "      Install with: sudo pacman -S ${missing_optional[*]}"
        fi
    fi
    
    return $status
}

# ==============================================================================
# Config Check
# ==============================================================================
check_configs() {
    local status=0
    echo ""
    echo "Checking configurations..."
    
    [[ -f "$UKE_CONFIG/registry.yaml" ]] && ok "registry.yaml exists" || { fail "registry.yaml missing"; status=1; }
    
    if is_macos; then
        [[ -f "$UKE_GEN/skhd/skhdrc" ]] && ok "skhd config generated" || { fail "skhd config missing - run 'uke gen'"; status=1; }
        [[ -f "$UKE_GEN/yabai/yabairc" ]] && ok "yabai config generated" || { fail "yabai config missing - run 'uke gen'"; status=1; }
    else
        [[ -f "$UKE_GEN/hyprland/hyprland.conf" ]] && ok "hyprland config generated" || { fail "hyprland config missing - run 'uke gen'"; status=1; }
        
        # Check keyd config
        if [[ -f "$UKE_STOW/keyd/.config/keyd/default.conf" ]]; then
            ok "keyd config exists in stow"
            
            if [[ -L /etc/keyd/default.conf ]]; then
                ok "keyd config linked to /etc/keyd/"
            elif [[ -f /etc/keyd/default.conf ]]; then
                log_warn "/etc/keyd/default.conf exists but is not a symlink"
            else
                log_warn "keyd config not linked - run 'scripts/keyd-setup.sh'"
            fi
        else
            log_warn "keyd config not found in stow/keyd/"
        fi
    fi
    
    return $status
}

# ==============================================================================
# Symlink Check
# ==============================================================================
check_links() {
    local status=0
    echo ""
    echo "Checking symlinks..."
    
    # Check binaries
    for bin in uke uke-bunch uke-gather uke-logs uke-scratchpad uke-session; do
        if [[ -x "$HOME/.local/bin/$bin" ]]; then
            ok "$bin linked"
        else
            fail "$bin not in ~/.local/bin"
            status=1
        fi
    done
    
    # Check config symlinks
    echo ""
    echo "Checking config symlinks..."
    
    if is_macos; then
        if [[ -L "$HOME/.config/skhd/skhdrc" ]]; then
            ok "skhdrc linked"
        else
            fail "skhdrc not linked"
            status=1
        fi
        
        if [[ -L "$HOME/.config/yabai/yabairc" ]]; then
            ok "yabairc linked"
        else
            fail "yabairc not linked"
            status=1
        fi
    else
        if [[ -L "$HOME/.config/hypr/hyprland.conf" ]]; then
            ok "hyprland.conf linked"
        else
            fail "hyprland.conf not linked"
            status=1
        fi
    fi
    
    # Check stowed dotfiles
    echo ""
    echo "Checking stowed dotfiles..."
    
    local dotfiles=(".wezterm.lua" ".tmux.conf" ".zshrc")
    for dot in "${dotfiles[@]}"; do
        if [[ -L "$HOME/$dot" ]]; then
            ok "$dot stowed"
        elif [[ -f "$HOME/$dot" ]]; then
            log_warn "$dot exists but not a symlink"
        else
            log_warn "$dot not found"
        fi
    done
    
    if [[ -L "$HOME/.config/nvim" ]] || [[ -d "$HOME/.config/nvim" ]]; then
        ok "nvim config exists"
    else
        log_warn "nvim config not found"
    fi
    
    return $status
}

# ==============================================================================
# Service Check
# ==============================================================================
check_services() {
    echo ""
    echo "Checking services..."
    
    if is_macos; then
        if pgrep -q yabai; then
            ok "yabai running"
        else
            fail "yabai not running"
        fi
        
        if pgrep -q skhd; then
            ok "skhd running"
        else
            fail "skhd not running"
        fi
    else
        if [[ -n "${HYPRLAND_INSTANCE_SIGNATURE:-}" ]]; then
            ok "hyprland running"
        else
            log_warn "hyprland not running (or not in Hyprland session)"
        fi
        
        # Check keyd service
        if command -v keyd &>/dev/null; then
            if systemctl is-active keyd &>/dev/null; then
                ok "keyd service active"
            else
                log_warn "keyd service not running - run 'sudo systemctl enable --now keyd'"
            fi
        fi
        
        # Check optional services
        if pgrep -x waybar &>/dev/null; then
            ok "waybar running"
        else
            log_warn "waybar not running (optional)"
        fi
        
        if pgrep -x dunst &>/dev/null; then
            ok "dunst running"
        else
            log_warn "dunst not running (optional)"
        fi
    fi
}

# ==============================================================================
# Arch-specific Checks
# ==============================================================================
check_arch() {
    if [[ ! -f /etc/arch-release ]]; then
        return 0
    fi
    
    echo ""
    echo "Arch Linux specific checks..."
    
    # Check if user is in input group (needed for keyd)
    if groups | grep -q '\binput\b'; then
        ok "User in 'input' group"
    else
        log_warn "User not in 'input' group (may be needed for keyd)"
        echo "      Add with: sudo usermod -aG input \$USER"
    fi
    
    # Check if Hyprland is in path
    if [[ -n "${XDG_SESSION_TYPE:-}" ]]; then
        echo "  Session type: $XDG_SESSION_TYPE"
    fi
    
    if [[ -n "${XDG_CURRENT_DESKTOP:-}" ]]; then
        echo "  Desktop: $XDG_CURRENT_DESKTOP"
    fi
}

# ==============================================================================
# Main
# ==============================================================================
main() {
    echo "╔══════════════════════════════════════╗"
    echo "║     UKE Doctor - Health Check        ║"
    echo "╚══════════════════════════════════════╝"
    echo ""
    echo "Platform: $UKE_OS"
    echo "UKE Root: $UKE_ROOT"
    echo "UKE Version: $UKE_VERSION"
    echo ""
    
    local overall=0
    
    check_deps || overall=1
    check_configs || overall=1
    check_links || overall=1
    check_services
    check_arch
    
    echo ""
    if [[ $overall -eq 0 ]]; then
        echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
        ok "All checks passed!"
    else
        echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
        fail "Some checks failed - see above"
        echo ""
        echo "Quick fixes:"
        echo "  uke gen           # Regenerate configs"
        echo "  uke install       # Re-run installer"
        echo "  uke reload        # Reload window manager"
    fi
    
    return $overall
}

main "$@"
