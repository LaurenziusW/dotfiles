#!/usr/bin/env bash
# ==============================================================================
# UKE Fix v7.2 - Quick Fixes for Common Issues
# ==============================================================================
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
export UKE_ROOT="${SCRIPT_DIR%/bin}"
source "$UKE_ROOT/lib/core.sh"

fix_audio() {
    info "Restarting audio stack..."
    systemctl --user restart pipewire pipewire-pulse wireplumber 2>/dev/null
    sleep 1
    if pactl info &>/dev/null; then
        ok "Audio restored"
    else
        fail "Audio still not working. Try: systemctl --user status pipewire"
    fi
}

fix_display() {
    info "Reloading Hyprland..."
    if [[ -n "${HYPRLAND_INSTANCE_SIGNATURE:-}" ]]; then
        hyprctl reload
        ok "Hyprland reloaded"
    else
        warn "Hyprland not running"
    fi
}

fix_keys() {
    info "Restarting keyd..."
    sudo systemctl restart keyd
    ok "keyd restarted"
}

fix_network() {
    info "Restarting NetworkManager..."
    sudo systemctl restart NetworkManager
    sleep 2
    if nmcli general status &>/dev/null; then
        ok "Network restored"
    else
        warn "Network may need more time"
    fi
}

fix_bluetooth() {
    info "Restarting Bluetooth..."
    sudo systemctl restart bluetooth
    ok "Bluetooth restarted"
}

fix_waybar() {
    info "Restarting Waybar..."
    pkill -x waybar 2>/dev/null || true
    sleep 0.5
    waybar &>/dev/null &
    disown
    ok "Waybar restarted"
}

fix_clipboard() {
    info "Fixing clipboard..."
    pkill -x wl-copy 2>/dev/null || true
    pkill -x wl-paste 2>/dev/null || true
    cliphist wipe 2>/dev/null || true
    ok "Clipboard cleared"
}

fix_cache() {
    info "Cleaning system caches..."
    
    # Package cache
    if command -v paccache &>/dev/null; then
        sudo paccache -rk2 2>/dev/null
        ok "Package cache cleaned"
    fi
    
    # Journal logs (keep last 100MB)
    sudo journalctl --vacuum-size=100M 2>/dev/null
    ok "Journal logs trimmed"
    
    # User cache (be careful)
    local cache_size=$(du -sh ~/.cache 2>/dev/null | cut -f1)
    info "User cache: $cache_size (not auto-cleaned for safety)"
}

fix_permissions() {
    info "Fixing common permission issues..."
    
    # Fix ~/.local/bin permissions
    chmod -R u+x ~/.local/bin 2>/dev/null || true
    
    # Fix UKE permissions
    chmod -R u+x "$UKE_ROOT/bin" 2>/dev/null || true
    chmod -R u+x "$UKE_ROOT/scripts" 2>/dev/null || true
    
    ok "Permissions fixed"
}

fix_all() {
    echo ""
    printf "%s╔══════════════════════════════════════╗%s\n" "$C_CYAN" "$C_RESET"
    printf "%s║%s        UKE Quick Fix                 %s║%s\n" "$C_CYAN" "$C_BOLD" "$C_CYAN" "$C_RESET"
    printf "%s╚══════════════════════════════════════╝%s\n" "$C_CYAN" "$C_RESET"
    echo ""
    
    fix_audio
    fix_keys
    fix_waybar
    fix_display
    fix_permissions
    
    echo ""
    ok "All fixes applied"
}

auto_detect() {
    echo ""
    printf "%s╔══════════════════════════════════════╗%s\n" "$C_CYAN" "$C_RESET"
    printf "%s║%s     UKE Auto-Detect & Fix            %s║%s\n" "$C_CYAN" "$C_BOLD" "$C_CYAN" "$C_RESET"
    printf "%s╚══════════════════════════════════════╝%s\n" "$C_CYAN" "$C_RESET"
    echo ""
    
    local fixed=0
    
    # Check audio
    if ! pactl info &>/dev/null; then
        warn "Audio not working"
        fix_audio
        ((fixed++))
    else
        ok "Audio OK"
    fi
    
    # Check keyd
    if ! systemctl is-active keyd &>/dev/null; then
        warn "keyd not running"
        fix_keys
        ((fixed++))
    else
        ok "keyd OK"
    fi
    
    # Check waybar
    if ! pgrep -x waybar &>/dev/null; then
        warn "Waybar not running"
        fix_waybar
        ((fixed++))
    else
        ok "Waybar OK"
    fi
    
    # Check network
    if ! nmcli general status &>/dev/null; then
        warn "Network issues detected"
        fix_network
        ((fixed++))
    else
        ok "Network OK"
    fi
    
    # Check disk space
    local free=$(df -BG / | awk 'NR==2 {print $4}' | tr -d 'G')
    if [[ $free -lt 5 ]]; then
        warn "Low disk space: ${free}GB"
        info "Run: uke-fix --cache or uke-update --clean"
    else
        ok "Disk space OK (${free}GB free)"
    fi
    
    echo ""
    if [[ $fixed -eq 0 ]]; then
        ok "No issues detected!"
    else
        ok "Fixed $fixed issue(s)"
    fi
}

case "${1:-}" in
    "")           auto_detect ;;
    --audio)      fix_audio ;;
    --display)    fix_display ;;
    --keys)       fix_keys ;;
    --network)    fix_network ;;
    --bluetooth)  fix_bluetooth ;;
    --waybar)     fix_waybar ;;
    --clipboard)  fix_clipboard ;;
    --cache)      fix_cache ;;
    --permissions) fix_permissions ;;
    --all)        fix_all ;;
    -h|--help)
        echo "Usage: uke-fix [option]"
        echo "Options:"
        echo "  (none)       Auto-detect and fix issues"
        echo "  --audio      Restart PipeWire audio stack"
        echo "  --display    Reload Hyprland"
        echo "  --keys       Restart keyd"
        echo "  --network    Restart NetworkManager"
        echo "  --bluetooth  Restart Bluetooth"
        echo "  --waybar     Restart Waybar"
        echo "  --clipboard  Clear clipboard"
        echo "  --cache      Clean system caches"
        echo "  --permissions Fix script permissions"
        echo "  --all        Fix everything"
        ;;
    *)            fail "Unknown option: $1" ;;
esac
