#!/usr/bin/env bash
# ==============================================================================
# UKE Services v7.2 - Service Health & Management
# ==============================================================================
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
export UKE_ROOT="${SCRIPT_DIR%/bin}"
source "$UKE_ROOT/lib/core.sh"

# Load services from registry if yq available, otherwise use defaults
load_services() {
    local registry="$UKE_ROOT/config/registry.yaml"
    
    if command -v yq &>/dev/null && [[ -f "$registry" ]]; then
        # Read from YAML
        mapfile -t SYSTEM_SERVICES < <(yq -r '.services.system[]' "$registry" 2>/dev/null || echo "")
        mapfile -t USER_SERVICES < <(yq -r '.services.user[]' "$registry" 2>/dev/null || echo "")
        mapfile -t HYPR_PROCESSES < <(yq -r '.services.hyprland[]' "$registry" 2>/dev/null || echo "")
    fi
    
    # Fallback to defaults if empty
    [[ ${#SYSTEM_SERVICES[@]} -eq 0 ]] && SYSTEM_SERVICES=(keyd bluetooth NetworkManager)
    [[ ${#USER_SERVICES[@]} -eq 0 ]] && USER_SERVICES=(pipewire pipewire-pulse wireplumber)
    [[ ${#HYPR_PROCESSES[@]} -eq 0 ]] && HYPR_PROCESSES=(waybar dunst hypridle hyprpaper)
}

load_services

show_status() {
    echo ""
    printf "%s╔══════════════════════════════════════╗%s\n" "$C_CYAN" "$C_RESET"
    printf "%s║%s        UKE Service Status            %s║%s\n" "$C_CYAN" "$C_BOLD" "$C_CYAN" "$C_RESET"
    printf "%s╚══════════════════════════════════════╝%s\n" "$C_CYAN" "$C_RESET"
    
    local issues=0
    
    echo ""
    printf "%s=== System Services ===%s\n" "$C_BOLD" "$C_RESET"
    for svc in "${SYSTEM_SERVICES[@]}"; do
        [[ -z "$svc" ]] && continue
        if systemctl is-active "$svc" &>/dev/null; then
            printf "  %s✓%s %-18s %sactive%s\n" "$C_GREEN" "$C_RESET" "$svc" "$C_GREEN" "$C_RESET"
        elif systemctl is-enabled "$svc" &>/dev/null; then
            printf "  %s!%s %-18s %senabled but stopped%s\n" "$C_YELLOW" "$C_RESET" "$svc" "$C_YELLOW" "$C_RESET"
            ((issues++))
        else
            printf "  %s-%s %-18s %snot enabled%s\n" "$C_DIM" "$C_RESET" "$svc" "$C_DIM" "$C_RESET"
        fi
    done
    
    echo ""
    printf "%s=== User Services ===%s\n" "$C_BOLD" "$C_RESET"
    for svc in "${USER_SERVICES[@]}"; do
        [[ -z "$svc" ]] && continue
        if systemctl --user is-active "$svc" &>/dev/null; then
            printf "  %s✓%s %-18s %sactive%s\n" "$C_GREEN" "$C_RESET" "$svc" "$C_GREEN" "$C_RESET"
        else
            printf "  %s✗%s %-18s %snot running%s\n" "$C_RED" "$C_RESET" "$svc" "$C_RED" "$C_RESET"
            ((issues++))
        fi
    done
    
    echo ""
    printf "%s=== Hyprland Ecosystem ===%s\n" "$C_BOLD" "$C_RESET"
    for proc in "${HYPR_PROCESSES[@]}"; do
        [[ -z "$proc" ]] && continue
        local pid=$(pgrep -x "$proc" 2>/dev/null | head -1)
        if [[ -n "$pid" ]]; then
            printf "  %s✓%s %-18s %srunning (PID %s)%s\n" "$C_GREEN" "$C_RESET" "$proc" "$C_GREEN" "$pid" "$C_RESET"
        else
            printf "  %s-%s %-18s %snot running%s\n" "$C_DIM" "$C_RESET" "$proc" "$C_DIM" "$C_RESET"
        fi
    done
    
    echo ""
    if [[ $issues -gt 0 ]]; then
        warn "$issues service(s) need attention"
        info "Run: uke-services restart"
    else
        ok "All critical services running"
    fi
}

restart_service() {
    local target="${1:-all}"
    
    if [[ "$target" == "all" ]]; then
        info "Restarting all services..."
        for svc in "${SYSTEM_SERVICES[@]}"; do
            [[ -z "$svc" ]] && continue
            sudo systemctl restart "$svc" 2>/dev/null && ok "Restarted: $svc" || warn "Failed: $svc"
        done
        for svc in "${USER_SERVICES[@]}"; do
            [[ -z "$svc" ]] && continue
            systemctl --user restart "$svc" 2>/dev/null && ok "Restarted: $svc" || warn "Failed: $svc"
        done
        for proc in "${HYPR_PROCESSES[@]}"; do
            [[ -z "$proc" ]] && continue
            pkill -x "$proc" 2>/dev/null || true
            sleep 0.3
            "$proc" &>/dev/null &
            disown 2>/dev/null || true
            ok "Restarted: $proc"
        done
    else
        # Check which type of service
        if printf '%s\n' "${SYSTEM_SERVICES[@]}" | grep -qx "$target"; then
            sudo systemctl restart "$target" && ok "Restarted: $target"
        elif printf '%s\n' "${USER_SERVICES[@]}" | grep -qx "$target"; then
            systemctl --user restart "$target" && ok "Restarted: $target"
        elif printf '%s\n' "${HYPR_PROCESSES[@]}" | grep -qx "$target"; then
            pkill -x "$target" 2>/dev/null || true
            sleep 0.3
            "$target" &>/dev/null &
            disown 2>/dev/null || true
            ok "Restarted: $target"
        else
            fail "Unknown service: $target"
            return 1
        fi
    fi
}

enable_services() {
    info "Enabling services at boot..."
    for svc in "${SYSTEM_SERVICES[@]}"; do
        [[ -z "$svc" ]] && continue
        sudo systemctl enable "$svc" 2>/dev/null && ok "Enabled: $svc" || warn "Skipped: $svc"
    done
    for svc in "${USER_SERVICES[@]}"; do
        [[ -z "$svc" ]] && continue
        systemctl --user enable "$svc" 2>/dev/null && ok "Enabled: $svc" || warn "Skipped: $svc"
    done
}

show_logs() {
    local svc="${1:-}"
    if [[ -z "$svc" ]]; then
        journalctl -b --no-pager -n 50
    elif printf '%s\n' "${SYSTEM_SERVICES[@]}" | grep -qx "$svc"; then
        journalctl -u "$svc" -b --no-pager -n 50
    elif printf '%s\n' "${USER_SERVICES[@]}" | grep -qx "$svc"; then
        journalctl --user -u "$svc" -b --no-pager -n 50
    else
        fail "Unknown service: $svc"
    fi
}

case "${1:-status}" in
    status)     show_status ;;
    restart)    restart_service "${2:-all}" ;;
    enable)     enable_services ;;
    disable)    info "Disabling not implemented (safety)" ;;
    logs)       show_logs "${2:-}" ;;
    list)
        echo "System:   ${SYSTEM_SERVICES[*]}"
        echo "User:     ${USER_SERVICES[*]}"
        echo "Hyprland: ${HYPR_PROCESSES[*]}"
        ;;
    -h|--help)
        echo "Usage: uke-services [command] [service]"
        echo "Commands:"
        echo "  status    Show service status (default)"
        echo "  restart   Restart services"
        echo "  enable    Enable services at boot"
        echo "  logs      View service logs"
        echo "  list      List managed services"
        ;;
    *)          fail "Unknown command: $1" ;;
esac
