#!/usr/bin/env bash
# =============================================================================
# UKE v8 - Doctor (Health Check)
# Performs comprehensive health checks on the UKE installation
# Usage: uke-doctor
# =============================================================================
set -euo pipefail

# Colors
if [[ -t 1 ]]; then
    C_RED=$'\e[31m' C_GREEN=$'\e[32m' C_YELLOW=$'\e[33m'
    C_CYAN=$'\e[36m' C_BOLD=$'\e[1m' C_DIM=$'\e[2m' C_RESET=$'\e[0m'
else
    C_RED='' C_GREEN='' C_YELLOW='' C_CYAN='' C_BOLD='' C_DIM='' C_RESET=''
fi

ERRORS=0
WARNINGS=0

# OS Detection
case "$(uname -s)" in
    Darwin) OS="macos" ;;
    Linux)  OS="linux" ;;
    *)      OS="unknown" ;;
esac

# =============================================================================
# Check Functions
# =============================================================================
ok()   { printf "%s✓%s %s\n" "$C_GREEN" "$C_RESET" "$*"; }
fail() { printf "%s✗%s %s\n" "$C_RED" "$C_RESET" "$*"; ((ERRORS++)); }
warn() { printf "%s!%s %s\n" "$C_YELLOW" "$C_RESET" "$*"; ((WARNINGS++)); }
info() { printf "%s→%s %s\n" "$C_CYAN" "$C_RESET" "$*"; }

check_cmd() {
    local cmd="$1"
    local hint="${2:-}"
    if command -v "$cmd" &>/dev/null; then
        ok "$cmd installed"
    else
        fail "$cmd not found"
        [[ -n "$hint" ]] && echo "    $hint"
    fi
}

check_file() {
    local file="$1"
    local hint="${2:-}"
    if [[ -f "$file" ]]; then
        ok "$file exists"
    else
        warn "$file missing"
        [[ -n "$hint" ]] && echo "    $hint"
    fi
}

check_symlink() {
    local link="$1"
    if [[ -L "$link" ]]; then
        ok "$link symlinked"
    elif [[ -f "$link" ]]; then
        warn "$link exists but not a symlink (stow not used?)"
    else
        warn "$link missing"
    fi
}

# =============================================================================
# Checks
# =============================================================================
echo ""
printf "%s╔══════════════════════════════════════╗%s\n" "$C_CYAN" "$C_RESET"
printf "%s║%s       UKE Doctor v8.0               %s║%s\n" "$C_CYAN" "$C_BOLD" "$C_CYAN" "$C_RESET"
printf "%s╚══════════════════════════════════════╝%s\n" "$C_CYAN" "$C_RESET"

# --- Core Dependencies ---
echo ""
printf "%s=== Core Dependencies ===%s\n" "$C_BOLD" "$C_RESET"

check_cmd "bash" ""
check_cmd "jq" "Install: brew install jq / pacman -S jq"
check_cmd "stow" "Install: brew install stow / pacman -S stow"

# --- Platform Dependencies ---
echo ""
printf "%s=== Platform Dependencies ===%s\n" "$C_BOLD" "$C_RESET"

if [[ "$OS" == "macos" ]]; then
    check_cmd "yabai" "Install: brew install koekeishiya/formulae/yabai"
    check_cmd "skhd" "Install: brew install koekeishiya/formulae/skhd"
else
    check_cmd "hyprctl" "Install: pacman -S hyprland"
    check_cmd "waybar" "Install: pacman -S waybar"
fi

# --- Config Files ---
echo ""
printf "%s=== Configuration Files ===%s\n" "$C_BOLD" "$C_RESET"

check_file "$HOME/.config/wezterm/wezterm.lua" "Run: cd shared && stow -t ~ ."
check_file "$HOME/.config/tmux/tmux.conf" "Run: cd shared && stow -t ~ ."
check_file "$HOME/.zshrc" "Run: cd shared && stow -t ~ ."

if [[ "$OS" == "macos" ]]; then
    check_file "$HOME/.config/skhd/skhdrc" "Run: cd mac && stow -t ~ ."
    check_file "$HOME/.config/yabai/yabairc" "Run: cd mac && stow -t ~ ."
else
    check_file "$HOME/.config/hypr/hyprland.conf" "Run: cd arch && stow -t ~ ."
    check_file "$HOME/.config/waybar/config" "Run: cd arch && stow -t ~ ."
fi

# --- UKE Scripts ---
echo ""
printf "%s=== UKE Scripts ===%s\n" "$C_BOLD" "$C_RESET"

for script in uke-gather uke-bunch; do
    if [[ -x "$HOME/.local/bin/$script" ]]; then
        ok "$script executable"
    elif [[ -f "$HOME/.local/bin/$script" ]]; then
        warn "$script exists but not executable"
        echo "    chmod +x ~/.local/bin/$script"
    else
        warn "$script missing"
        echo "    Run: cd shared && stow -t ~ ."
    fi
done

# --- Services ---
echo ""
printf "%s=== Services ===%s\n" "$C_BOLD" "$C_RESET"

if [[ "$OS" == "macos" ]]; then
    if pgrep -q yabai; then
        ok "yabai running"
    else
        warn "yabai not running"
        echo "    Start: yabai --start-service"
    fi
    
    if pgrep -q skhd; then
        ok "skhd running"
    else
        warn "skhd not running"
        echo "    Start: skhd --start-service"
    fi
else
    if [[ -n "${HYPRLAND_INSTANCE_SIGNATURE:-}" ]]; then
        ok "Hyprland running"
    else
        warn "Hyprland not running (or not in Hyprland session)"
    fi
    
    if systemctl is-active keyd &>/dev/null; then
        ok "keyd service active"
    else
        warn "keyd not running"
        echo "    Start: sudo systemctl start keyd"
    fi
fi

# --- Local Overrides ---
echo ""
printf "%s=== Local Overrides (Optional) ===%s\n" "$C_BOLD" "$C_RESET"

[[ -f "$HOME/.config/wezterm/local.lua" ]] && ok "wezterm local.lua" || info "No wezterm local.lua (optional)"
[[ -f "$HOME/.zshrc.local" ]] && ok ".zshrc.local" || info "No .zshrc.local (optional)"

if [[ "$OS" == "macos" ]]; then
    [[ -f "$HOME/.config/yabai/local_rules" ]] && ok "yabai local_rules" || info "No yabai local_rules (optional)"
else
    [[ -f "$HOME/.config/hypr/local.conf" ]] && ok "hyprland local.conf" || info "No hyprland local.conf (optional)"
fi

# --- Summary ---
echo ""
printf "%s━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━%s\n" "$C_DIM" "$C_RESET"
echo ""

if [[ $ERRORS -eq 0 ]] && [[ $WARNINGS -eq 0 ]]; then
    printf "%s✓ All checks passed!%s\n" "$C_GREEN$C_BOLD" "$C_RESET"
elif [[ $ERRORS -eq 0 ]]; then
    printf "%s! %d warning(s), 0 errors%s\n" "$C_YELLOW$C_BOLD" "$WARNINGS" "$C_RESET"
else
    printf "%s✗ %d error(s), %d warning(s)%s\n" "$C_RED$C_BOLD" "$ERRORS" "$WARNINGS" "$C_RESET"
fi

echo ""
echo "Quick fixes:"
echo "  cd ~/dotfiles/uke-v8/shared && stow -t ~ ."
if [[ "$OS" == "macos" ]]; then
    echo "  cd ~/dotfiles/uke-v8/mac && stow -t ~ ."
    echo "  yabai --restart-service && skhd --restart-service"
else
    echo "  cd ~/dotfiles/uke-v8/arch && stow -t ~ ."
    echo "  hyprctl reload"
fi

exit $ERRORS
