#!/usr/bin/env bash
# =============================================================================
# UKE v8 - Scratchpad (Dropdown/Toggle Windows)
# Toggles scratchpad windows - special floating windows that appear on demand
# Usage: uke-scratchpad <n> (terminal|notes|music|calc)
# =============================================================================
set -euo pipefail

# Colors
if [[ -t 1 ]]; then
    C_GREEN=$'\e[32m' C_RED=$'\e[31m' C_CYAN=$'\e[36m' C_RESET=$'\e[0m'
else
    C_GREEN='' C_RED='' C_CYAN='' C_RESET=''
fi

ok()   { printf "%s✓%s %s\n" "$C_GREEN" "$C_RESET" "$*"; }
fail() { printf "%s✗%s %s\n" "$C_RED" "$C_RESET" "$*"; }
info() { printf "%s→%s %s\n" "$C_CYAN" "$C_RESET" "$*"; }

NAME="${1:-terminal}"

# OS Detection
case "$(uname -s)" in
    Darwin) OS="macos" ;;
    Linux)  OS="linux" ;;
    *)      fail "Unsupported OS"; exit 1 ;;
esac

# =============================================================================
# Scratchpad Configuration
# =============================================================================
get_app() {
    local name="$1"
    case "$name" in
        terminal)
            [[ "$OS" == "macos" ]] && echo "WezTerm" || echo "wezterm"
            ;;
        notes)
            [[ "$OS" == "macos" ]] && echo "Obsidian" || echo "obsidian"
            ;;
        music)
            [[ "$OS" == "macos" ]] && echo "Spotify" || echo "spotify"
            ;;
        calc)
            [[ "$OS" == "macos" ]] && echo "Calculator" || echo "gnome-calculator"
            ;;
        *)
            fail "Unknown scratchpad: $name"
            exit 1
            ;;
    esac
}

# =============================================================================
# macOS Implementation (Yabai)
# =============================================================================
scratchpad_macos() {
    local name="$1"
    local app
    app=$(get_app "$name")
    
    # Check if app window exists
    local window_id
    window_id=$(yabai -m query --windows | jq -r ".[] | select(.app == \"$app\") | .id" | head -1)
    
    if [[ -n "$window_id" ]]; then
        # Window exists - check if focused
        local focused
        focused=$(yabai -m query --windows --window | jq -r '.id' 2>/dev/null || echo "")
        
        if [[ "$focused" == "$window_id" ]]; then
            # Already focused - hide it (minimize or send to space 11)
            yabai -m window "$window_id" --space 11 2>/dev/null || \
                yabai -m window "$window_id" --minimize
            info "Hidden: $app"
        else
            # Not focused - bring to current space and focus
            yabai -m window "$window_id" --space mouse
            yabai -m window "$window_id" --focus
            yabai -m window "$window_id" --toggle float 2>/dev/null || true
            info "Focused: $app"
        fi
    else
        # Window doesn't exist - launch app
        open -a "$app"
        info "Launched: $app"
        
        # Wait and configure
        sleep 0.5
        window_id=$(yabai -m query --windows | jq -r ".[] | select(.app == \"$app\") | .id" | head -1)
        if [[ -n "$window_id" ]]; then
            yabai -m window "$window_id" --toggle float
            # Position based on type
            case "$name" in
                terminal)
                    yabai -m window "$window_id" --resize abs:1200:400
                    yabai -m window "$window_id" --move abs:100:50
                    ;;
                notes)
                    yabai -m window "$window_id" --resize abs:1000:800
                    yabai -m window "$window_id" --grid 8:8:1:1:6:6
                    ;;
                music)
                    yabai -m window "$window_id" --resize abs:800:600
                    yabai -m window "$window_id" --grid 8:8:2:2:4:4
                    ;;
                calc)
                    yabai -m window "$window_id" --grid 8:8:3:3:2:2
                    ;;
            esac
        fi
    fi
}

# =============================================================================
# Linux Implementation (Hyprland Special Workspaces)
# =============================================================================
scratchpad_linux() {
    local name="$1"
    local app
    app=$(get_app "$name")
    
    # Use Hyprland special workspaces
    local special_ws="special:$name"
    
    # Check if window exists in special workspace
    local window_count
    window_count=$(hyprctl clients -j | jq "[.[] | select(.workspace.name == \"$special_ws\")] | length")
    
    if [[ "$window_count" -gt 0 ]]; then
        # Toggle visibility
        hyprctl dispatch togglespecialworkspace "$name"
    else
        # Launch app into special workspace
        hyprctl dispatch exec "[workspace $special_ws] $app"
        sleep 0.3
        hyprctl dispatch togglespecialworkspace "$name"
    fi
    
    info "Toggled scratchpad: $name"
}

# =============================================================================
# Help
# =============================================================================
show_help() {
    cat <<EOF
Usage: uke-scratchpad <n>

Available scratchpads:
  terminal  - WezTerm terminal (dropdown from top)
  notes     - Obsidian notes (centered)
  music     - Spotify player (centered)
  calc      - Calculator (small, centered)

Examples:
  uke-scratchpad terminal
  uke-scratchpad notes
  uke-scratchpad music

macOS: Uses yabai to toggle floating windows
Linux: Uses Hyprland special workspaces
EOF
}

# =============================================================================
# Main
# =============================================================================
case "$NAME" in
    terminal|notes|music|calc)
        [[ "$OS" == "macos" ]] && scratchpad_macos "$NAME" || scratchpad_linux "$NAME"
        ;;
    list)
        echo "Available: terminal, notes, music, calc"
        ;;
    -h|--help|help)
        show_help
        ;;
    *)
        fail "Unknown scratchpad: $NAME"
        show_help
        exit 1
        ;;
esac
