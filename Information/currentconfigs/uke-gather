#!/usr/bin/env bash
# =============================================================================
# UKE v8 - uke-gather
# Moves windows to their assigned workspaces based on app name
# Triggered by: Cmd+` (macOS) / Alt+` (Linux)
# =============================================================================

set -euo pipefail

# -----------------------------------------------------------------------------
# OS Detection
# -----------------------------------------------------------------------------
case "$(uname -s)" in
    Darwin) OS="macos" ;;
    Linux)  OS="linux" ;;
    *)      echo "Unsupported OS"; exit 1 ;;
esac

# -----------------------------------------------------------------------------
# Workspace Assignments
# Format: "AppName:WorkspaceNumber"
# -----------------------------------------------------------------------------
declare -A APP_WORKSPACE=(
    # Workspace 1: Browser
    ["Safari"]=1
    ["Brave Browser"]=1
    ["Firefox"]=1
    ["Google Chrome"]=1
    
    # Workspace 2: Notes
    ["Obsidian"]=2
    ["Notion"]=2
    
    # Workspace 3: Code
    ["WezTerm"]=3
    ["Code"]=3
    ["Visual Studio Code"]=3
    ["Xcode"]=3
    ["kitty"]=3
    ["Alacritty"]=3
    
    # Workspace 4: Catch-all (default)
    
    # Workspace 5: Documents
    ["Preview"]=5
    ["PDF Expert"]=5
    ["Skim"]=5
    ["Zathura"]=5
    
    # Workspace 6: Raindrop
    ["Raindrop.io"]=6
    
    # Workspace 7: Media
    ["Spotify"]=7
    ["Music"]=7
    ["VLC"]=7
    
    # Workspace 8: Office
    ["Microsoft Word"]=8
    ["Microsoft Excel"]=8
    ["Microsoft PowerPoint"]=8
    ["LibreOffice Writer"]=8
    ["LibreOffice Calc"]=8
    
    # Workspace 9: Communications
    ["Slack"]=9
    ["Discord"]=9
    ["Mail"]=9
    ["Telegram"]=9
    ["Messages"]=9
    ["Thunderbird"]=9
    
    # Workspace 10: AI
    ["Claude"]=10
    ["Perplexity"]=10
    ["ChatGPT"]=10
)

# -----------------------------------------------------------------------------
# macOS: Yabai
# -----------------------------------------------------------------------------
gather_macos() {
    # Get all windows as JSON
    local windows
    windows=$(yabai -m query --windows)
    
    # Parse each window and move to correct workspace
    echo "$windows" | jq -r '.[] | "\(.id)|\(.app)"' | while IFS='|' read -r window_id app_name; do
        # Look up workspace for this app
        local target_ws="${APP_WORKSPACE[$app_name]:-}"
        
        if [[ -n "$target_ws" ]]; then
            # Move window to target workspace
            yabai -m window "$window_id" --space "$target_ws" 2>/dev/null || true
        fi
    done
    
    echo "Windows gathered."
}

# -----------------------------------------------------------------------------
# Linux: Hyprland
# -----------------------------------------------------------------------------
gather_linux() {
    # Get all windows
    local windows
    windows=$(hyprctl clients -j)
    
    # Parse each window and move to correct workspace
    echo "$windows" | jq -r '.[] | "\(.address)|\(.class)"' | while IFS='|' read -r address class_name; do
        # Look up workspace for this app class
        local target_ws="${APP_WORKSPACE[$class_name]:-}"
        
        if [[ -n "$target_ws" ]]; then
            # Move window to target workspace
            hyprctl dispatch movetoworkspacesilent "$target_ws,address:$address" 2>/dev/null || true
        fi
    done
    
    echo "Windows gathered."
}

# -----------------------------------------------------------------------------
# Main
# -----------------------------------------------------------------------------
case "$OS" in
    macos) gather_macos ;;
    linux) gather_linux ;;
esac
