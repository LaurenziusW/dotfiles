#!/usr/bin/env bash
# ==============================================================================
# UKE Bunch - Environment Preset Runner
# ==============================================================================
# Runs a "bunch" - a preset environment that launches specific apps.
#
# Usage: uke-bunch <n>
# Example: uke-bunch coding
# ==============================================================================
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
export UKE_ROOT="${SCRIPT_DIR%/bin}"

if [[ -f "$SCRIPT_DIR/../lib/core.sh" ]]; then
    source "$SCRIPT_DIR/../lib/core.sh"
else
    ok() { echo "OK: $*"; }
    log_error() { echo "ERROR: $*" >&2; }
    log_info() { echo "INFO: $*"; }
fi

BUNCH_NAME="${1:-}"
BUNCH_DIR="$UKE_CONFIG/bunches"

# ==============================================================================
# List Available Bunches
# ==============================================================================
list_bunches() {
    echo "Available bunches:"
    if [[ -d "$BUNCH_DIR" ]]; then
        for f in "$BUNCH_DIR"/*.sh; do
            [[ -f "$f" ]] || continue
            local name
            name=$(basename "$f" .sh)
            # Try to extract description
            local desc
            desc=$(grep -m1 "^# BUNCH:" "$f" 2>/dev/null | sed 's/# BUNCH: [^-]*- //' || echo "")
            printf "  %-12s %s\n" "$name" "$desc"
        done
    else
        echo "  (No bunches found in $BUNCH_DIR)"
    fi
}

# ==============================================================================
# Run Bunch
# ==============================================================================
run_bunch() {
    local name="$1"
    local script="$BUNCH_DIR/${name}.sh"
    
    if [[ ! -f "$script" ]]; then
        log_error "Bunch not found: $name"
        echo ""
        list_bunches
        exit 1
    fi
    
    log_info "Running bunch: $name"
    bash "$script"
}

# ==============================================================================
# Main
# ==============================================================================
if [[ -z "$BUNCH_NAME" ]]; then
    list_bunches
    exit 0
fi

case "$BUNCH_NAME" in
    list|--list|-l)
        list_bunches
        ;;
    help|--help|-h)
        echo "Usage: uke-bunch <name>"
        echo ""
        list_bunches
        ;;
    *)
        run_bunch "$BUNCH_NAME"
        ;;
esac
