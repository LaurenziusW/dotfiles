#!/usr/bin/env bash
# ==============================================================================
# UKE Bunch Runner
# ==============================================================================
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
export UKE_ROOT="${SCRIPT_DIR%/bin}"
source "$UKE_ROOT/lib/core.sh"
source "$UKE_ROOT/lib/wm.sh"

require_cmd yq

REGISTRY="$UKE_CONFIG/registry.yaml"

launch_app() {
    local app="$1"
    local bundle
    
    if is_macos; then
        bundle=$(yq -r ".apps.$app.macos // \"\"" "$REGISTRY")
        [[ -n "$bundle" ]] && open -b "$bundle" &
    else
        bundle=$(yq -r ".apps.$app.linux // \"\"" "$REGISTRY")
        [[ -n "$bundle" ]] && {
            local cmd="${bundle,,}"
            command -v "$cmd" &>/dev/null && "$cmd" &>/dev/null &
        }
    fi
}

run_bunch() {
    local name="$1"
    
    local bunch_data
    bunch_data=$(yq -r ".bunches.$name // \"\"" "$REGISTRY")
    [[ -z "$bunch_data" ]] && log_fatal "Bunch not found: $name"
    
    log_info "Starting bunch: $name"
    
    local apps focus
    apps=$(yq -r ".bunches.$name.apps[]" "$REGISTRY" 2>/dev/null || true)
    focus=$(yq -r ".bunches.$name.focus // \"\"" "$REGISTRY")
    
    for app in $apps; do
        log_debug "Launching: $app"
        launch_app "$app"
    done
    
    sleep 2
    
    if [[ -n "$focus" ]]; then
        log_debug "Focusing workspace: $focus"
        wm_workspace "$focus"
    fi
    
    ok "Bunch '$name' started"
}

list_bunches() {
    echo "Available bunches:"
    yq -r '.bunches | to_entries[] | "  \(.key): \(.value.apps | join(", "))"' "$REGISTRY" 2>/dev/null || echo "  (none defined)"
}

case "${1:-}" in
    ""|list) list_bunches ;;
    *) run_bunch "$1" ;;
esac
