#!/usr/bin/env bash
# ==============================================================================
# UKE Gather - Organize windows to correct workspaces
# ==============================================================================
# This script detects the current workspace and gathers all windows that
# "belong" to it based on the app assignments in registry.yaml
# ==============================================================================
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
export UKE_ROOT="${SCRIPT_DIR%/bin}"
source "$UKE_ROOT/lib/core.sh"
source "$UKE_ROOT/lib/wm.sh"

require_cmd jq

# Hardcoded app-to-workspace mapping (matches registry.yaml)
# This is more reliable than parsing YAML at runtime
declare -A APP_WS=(
    # Space 1: Browser
    ["Safari"]=1
    ["Brave Browser"]=1
    
    # Space 2: Notes
    ["Obsidian"]=2
    
    # Space 3: Code
    ["WezTerm"]=3
    ["Code"]=3
    ["Xcode"]=3
    
    # Space 5: Documents
    ["Preview"]=5
    ["PDF Expert"]=5
    
    # Space 6: Raindrop
    ["Raindrop.io"]=6
    
    # Space 7: Media
    ["Spotify"]=7
    
    # Space 8: Office
    ["Microsoft Word"]=8
    ["Microsoft Excel"]=8
    ["Microsoft PowerPoint"]=8
    
    # Space 9: Communication
    ["Slack"]=9
    ["Discord"]=9
    ["Mail"]=9
    ["Telegram"]=9
    ["WhatsApp"]=9
    
    # Space 10: AI
    ["Claude"]=10
    ["Perplexity"]=10
)

gather_macos() {
    local current_ws
    current_ws=$(wm_current_workspace)
    log_info "Gathering windows for macOS Space $current_ws..."
    
    local windows
    windows=$(yabai -m query --windows 2>/dev/null) || { log_error "Failed to query windows"; return 1; }
    
    echo "$windows" | jq -c '.[]' 2>/dev/null | while read -r win; do
        local app_name space wid
        app_name=$(echo "$win" | jq -r '.app')
        space=$(echo "$win" | jq -r '.space')
        wid=$(echo "$win" | jq -r '.id')
        
        # Check if this app has a designated workspace
        if [[ -n "${APP_WS[$app_name]:-}" ]]; then
            local target="${APP_WS[$app_name]}"
            if [[ "$space" != "$target" ]]; then
                log_debug "Moving $app_name (id: $wid) from space $space to space $target"
                yabai -m window "$wid" --space "$target" 2>/dev/null || true
            fi
        fi
    done
    
    ok "Windows gathered"
}

gather_linux() {
    local current_ws
    current_ws=$(wm_current_workspace)
    log_info "Gathering windows for Linux Workspace $current_ws..."
    
    local windows
    windows=$(hyprctl clients -j 2>/dev/null) || { log_error "Failed to query windows"; return 1; }
    
    # Linux class names (from registry.yaml)
    declare -A LINUX_WS=(
        ["Safari"]=1
        ["Brave-browser"]=1
        ["obsidian"]=2
        ["org.wezfurlong.wezterm"]=3
        ["Code"]=3
        ["org.gnome.Evince"]=5
        ["PDFExpert"]=5
        ["Raindrop"]=6
        ["Spotify"]=7
        ["libreoffice-writer"]=8
        ["libreoffice-calc"]=8
        ["libreoffice-impress"]=8
        ["Slack"]=9
        ["discord"]=9
        ["thunderbird"]=9
        ["org.telegram.desktop"]=9
    )
    
    echo "$windows" | jq -c '.[]' 2>/dev/null | while read -r win; do
        local class current addr
        class=$(echo "$win" | jq -r '.class')
        current=$(echo "$win" | jq -r '.workspace.id')
        addr=$(echo "$win" | jq -r '.address')
        
        if [[ -n "${LINUX_WS[$class]:-}" ]]; then
            local target="${LINUX_WS[$class]}"
            if [[ "$current" != "$target" ]]; then
                log_debug "Moving $class to workspace $target"
                hyprctl dispatch movetoworkspacesilent "$target,address:$addr" 2>/dev/null || true
            fi
        fi
    done
    
    ok "Windows gathered"
}

is_macos && gather_macos "$@" || gather_linux "$@"
