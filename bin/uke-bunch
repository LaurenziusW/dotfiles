#!/usr/bin/env bash
# ==============================================================================
# UKE Bunch Runner
# ==============================================================================
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
export UKE_ROOT="${SCRIPT_DIR%/bin}"
source "$UKE_ROOT/lib/core.sh"
source "$UKE_ROOT/lib/wm.sh"

require_cmd yq

REGISTRY="$UKE_CONFIG/registry.yaml"

# ------------------------------------------------------------------------------
# App Launcher
# ------------------------------------------------------------------------------
launch_app() {
    local app="$1"
    local bundle
    
    if is_macos; then
        bundle=$(yq -r ".apps.$app.macos // empty" "$REGISTRY")
        [[ -n "$bundle" ]] && open -b "$bundle" &
    else
        bundle=$(yq -r ".apps.$app.linux // empty" "$REGISTRY")
        [[ -n "$bundle" ]] && {
            local cmd="${bundle,,}"
            command -v "$cmd" &>/dev/null && "$cmd" &>/dev/null &
        }
    fi
}

# ------------------------------------------------------------------------------
# Run Bunch
# ------------------------------------------------------------------------------
run_bunch() {
    local name="$1"
    
    # Check if bunch exists
    local bunch_data
    bunch_data=$(yq -r ".bunches.$name // empty" "$REGISTRY")
    [[ -z "$bunch_data" ]] && log_fatal "Bunch not found: $name"
    
    log_info "Starting bunch: $name"
    
    # Get apps and focus workspace
    local apps focus
    apps=$(yq -r ".bunches.$name.apps[]" "$REGISTRY")
    focus=$(yq -r ".bunches.$name.focus // empty" "$REGISTRY")
    
    # Launch apps
    for app in $apps; do
        log_debug "Launching: $app"
        launch_app "$app"
    done
    
    # Wait for apps to start
    sleep 2
    
    # Focus workspace
    if [[ -n "$focus" ]]; then
        log_debug "Focusing workspace: $focus"
        wm_workspace "$focus"
    fi
    
    ok "Bunch '$name' started"
}

# ------------------------------------------------------------------------------
# List Bunches
# ------------------------------------------------------------------------------
list_bunches() {
    echo "Available bunches:"
    yq -r '.bunches | to_entries[] | "  \(.key): \(.value.apps | join(", "))"' "$REGISTRY"
}

# ------------------------------------------------------------------------------
# Main
# ------------------------------------------------------------------------------
case "${1:-}" in
    ""|list) list_bunches ;;
    *) run_bunch "$1" ;;
esac
