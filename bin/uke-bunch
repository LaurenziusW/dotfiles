#!/usr/bin/env bash
# ==============================================================================
# UKE Bunch Runner - Environment Presets
# ==============================================================================
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
export UKE_ROOT="${SCRIPT_DIR%/bin}"
source "$UKE_ROOT/lib/core.sh"
source "$UKE_ROOT/lib/wm.sh"

# Bunch definitions (matching registry.yaml)
declare -A BUNCH_APPS=(
    ["study"]="obsidian brave wezterm preview"
    ["guitar"]="spotify brave"
    ["coding"]="wezterm vscode brave"
    ["email"]="mail slack brave"
    ["reading"]="preview obsidian"
)

declare -A BUNCH_FOCUS=(
    ["study"]=2
    ["guitar"]=7
    ["coding"]=3
    ["email"]=9
    ["reading"]=5
)

# App launch commands
declare -A APP_MACOS=(
    ["safari"]="open -a Safari"
    ["brave"]="open -a 'Brave Browser'"
    ["obsidian"]="open -a Obsidian"
    ["wezterm"]="open -a WezTerm"
    ["vscode"]="open -a Code"
    ["preview"]="open -a Preview"
    ["spotify"]="open -a Spotify"
    ["slack"]="open -a Slack"
    ["discord"]="open -a Discord"
    ["mail"]="open -a Mail"
)

declare -A APP_LINUX=(
    ["brave"]="brave"
    ["obsidian"]="obsidian"
    ["wezterm"]="wezterm"
    ["vscode"]="code"
    ["preview"]="evince"
    ["spotify"]="spotify"
    ["slack"]="slack"
    ["discord"]="discord"
    ["mail"]="thunderbird"
)

launch_app() {
    local app="$1"
    
    if is_macos; then
        local cmd="${APP_MACOS[$app]:-}"
        if [[ -n "$cmd" ]]; then
            eval "$cmd" &
        fi
    else
        local cmd="${APP_LINUX[$app]:-}"
        if [[ -n "$cmd" ]] && command -v "$cmd" &>/dev/null; then
            "$cmd" &>/dev/null &
        fi
    fi
}

run_bunch() {
    local name="$1"
    
    local apps="${BUNCH_APPS[$name]:-}"
    [[ -z "$apps" ]] && log_fatal "Bunch not found: $name"
    
    log_info "Starting bunch: $name"
    
    # Launch all apps
    for app in $apps; do
        log_debug "Launching: $app"
        launch_app "$app"
    done
    
    # Wait a moment for apps to start
    sleep 2
    
    # Focus the target workspace
    local focus="${BUNCH_FOCUS[$name]:-}"
    if [[ -n "$focus" ]]; then
        log_debug "Focusing workspace: $focus"
        wm_workspace "$focus"
    fi
    
    ok "Bunch '$name' started"
}

list_bunches() {
    echo "Available bunches:"
    for bunch in "${!BUNCH_APPS[@]}"; do
        echo "  $bunch: ${BUNCH_APPS[$bunch]}"
    done
}

case "${1:-}" in
    ""|list) list_bunches ;;
    *) run_bunch "$1" ;;
esac
