#!/usr/bin/env bash
# ==============================================================================
# UKE - Unified Keyboard Environment CLI v7.0
# ==============================================================================
# Main command-line interface for UKE.
#
# Usage: uke <command> [args]
#
# Commands:
#   gen        Generate configs from registry.yaml
#   apply      Generate hardware configs from machine.profile
#   profile    Manage hardware profile (TUI)
#   reload     Reload window manager
#   status     Show current status
#   validate   Validate configuration
#   edit       Edit config files
#   log        Manage logs
#   install    Run installer
#   doctor     Health check
#   help       Show help
# ==============================================================================
set -euo pipefail

# ==============================================================================
# Path Resolution
# ==============================================================================
SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do
  DIR="$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE"
done
SCRIPT_DIR="$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"
export UKE_ROOT="${SCRIPT_DIR%/bin}"



source "$UKE_ROOT/lib/core.sh"
source "$UKE_ROOT/lib/wm.sh"

# ==============================================================================
# Commands
# ==============================================================================

cmd_gen() {
    local target="${1:-all}"
    bash "$UKE_LIB/gen.sh" "$target"
}

cmd_apply() {
    local flags="${1:-}"
    bash "$UKE_SCRIPTS/apply_profile.sh" $flags
}

cmd_profile() {
    bash "$UKE_SCRIPTS/manage_profile.sh" "$@"
}

cmd_reload() {
    wm_reload
}

cmd_status() {
    echo ""
    printf "%s╔══════════════════════════════════════╗%s\n" "$C_CYAN" "$C_RESET"
    printf "%s║%s       UKE v%s Status                 %s║%s\n" "$C_CYAN" "$C_BOLD" "$UKE_VERSION" "$C_CYAN" "$C_RESET"
    printf "%s╚══════════════════════════════════════╝%s\n" "$C_CYAN" "$C_RESET"
    echo ""
    
    echo "Platform:    $UKE_OS"
    [[ -n "$UKE_DISTRO" ]] && echo "Distro:      $UKE_DISTRO"
    echo "UKE Root:    $UKE_ROOT"
    echo "Config Path: $UKE_CONFIG_SOURCE"
    echo ""
    
    # Hardware profile
    if has_profile; then
        load_hardware_profile
        ok "Hardware Profile:"
        echo "  OS:          $(get_profile OS)"
        echo "  Form Factor: $(get_profile FORM_FACTOR)"
        echo "  Monitors:    $(get_profile MONITORS)"
        echo "  GPU:         $(get_profile GPU)"
        echo "  Keyboard:    $(get_profile KEYBOARD)"
    else
        warn "No hardware profile found"
        info "Run 'uke profile' to create one"
    fi
    echo ""
    
    # Window manager status
    if wm_running; then
        ok "Window Manager: $(wm_name) running"
        echo "  Workspace: $(wm_current_workspace 2>/dev/null || echo 'unknown')"
    else
        fail "Window Manager: not running"
    fi
    echo ""
    
    # Cloud path
    if [[ -n "${UKE_CLOUD_PATH:-}" ]]; then
        if [[ -d "$UKE_CLOUD_PATH" ]]; then
            ok "Cloud Path: $UKE_CLOUD_PATH"
        else
            warn "Cloud Path: $UKE_CLOUD_PATH (not found)"
        fi
    fi
}

cmd_validate() {
    log_info "Validating configuration..."
    local errors=0
    
    # Check registry
    if [[ -f "$UKE_CONFIG/registry.yaml" ]]; then
        ok "registry.yaml exists"
    else
        fail "registry.yaml missing at $UKE_CONFIG/registry.yaml"
        ((errors++))
    fi
    
    # Check generated configs
    if is_macos; then
        [[ -f "$UKE_GEN/skhd/skhdrc" ]] && ok "skhd config exists" || { fail "skhd config missing"; ((errors++)); }
        [[ -f "$UKE_GEN/yabai/yabairc" ]] && ok "yabai config exists" || { fail "yabai config missing"; ((errors++)); }
    else
        [[ -f "$UKE_GEN/hyprland/hyprland.conf" ]] && ok "hyprland config exists" || { fail "hyprland config missing"; ((errors++)); }
    fi
    
    # Check hardware profile and ghost files
    if has_profile; then
        ok "Hardware profile exists"
        
        if is_macos; then
            [[ -f "$HOME/.config/yabai/generated_hardware.conf" ]] && ok "yabai ghost file exists" || warn "yabai ghost file missing (run 'uke apply')"
        else
            [[ -f "$HOME/.config/hypr/generated_hardware.conf" ]] && ok "hyprland ghost file exists" || warn "hyprland ghost file missing (run 'uke apply')"
        fi
        
        [[ -f "$HOME/.config/alacritty/generated_font.toml" ]] && ok "alacritty ghost file exists" || warn "alacritty ghost file missing"
        [[ -f "$HOME/.config/wezterm/generated_hardware.lua" ]] && ok "wezterm ghost file exists" || warn "wezterm ghost file missing"
    else
        warn "No hardware profile - run 'uke profile' to create one"
    fi
    
    echo ""
    if [[ $errors -eq 0 ]]; then
        ok "All validations passed!"
    else
        fail "$errors error(s) found"
        return 1
    fi
}

cmd_edit() {
    local target="${1:-registry}"
    local file
    
    case "$target" in
        registry|reg)  file="$UKE_CONFIG/registry.yaml" ;;
        profile)       file="$UKE_PROFILE_FILE" ;;
        skhd)          file="$UKE_GEN/skhd/skhdrc" ;;
        yabai)         file="$UKE_GEN/yabai/yabairc" ;;
        hyprland)      file="$UKE_GEN/hyprland/hyprland.conf" ;;
        *)             log_fatal "Unknown target: $target (use: registry|profile|skhd|yabai|hyprland)" ;;
    esac
    
    if [[ ! -f "$file" ]]; then
        log_fatal "File not found: $file"
    fi
    
    ${EDITOR:-nvim} "$file"
}

cmd_log() {
    case "${1:-tail}" in
        tail)  tail -n "${2:-50}" "$UKE_LOG_FILE" 2>/dev/null || echo "No logs" ;;
        clear) : > "$UKE_LOG_FILE" && ok "Log cleared" ;;
        path)  echo "$UKE_LOG_FILE" ;;
        *)     log_fatal "Unknown: $1 (use: tail|clear|path)" ;;
    esac
}

cmd_install() {
    if [[ -x "$UKE_SCRIPTS/install.sh" ]]; then
        bash "$UKE_SCRIPTS/install.sh" "$@"
    else
        log_fatal "Installer not found: $UKE_SCRIPTS/install.sh"
    fi
}

cmd_doctor() {
    if [[ -x "$UKE_BIN/uke-doctor" ]]; then
        bash "$UKE_BIN/uke-doctor" "$@"
    else
        # Inline basic health check
        log_info "Running basic health check..."
        cmd_validate
    fi
}

cmd_help() {
    cat << EOF
${C_CYAN}╔══════════════════════════════════════════════════════════════╗${C_RESET}
${C_CYAN}║${C_BOLD}       UKE v$UKE_VERSION - Unified Keyboard Environment          ${C_CYAN}║${C_RESET}
${C_CYAN}╚══════════════════════════════════════════════════════════════╝${C_RESET}

${C_BOLD}Usage:${C_RESET} uke <command> [args]

${C_BOLD}Core Commands:${C_RESET}
  gen [target]     Generate configs from registry.yaml
                   Targets: skhd|yabai|hyprland|gather|all
  apply [--dry-run] Generate hardware configs from machine.profile
  profile          Manage hardware profile (interactive TUI)
  reload           Reload window manager

${C_BOLD}Info Commands:${C_RESET}
  status           Show current status
  validate         Validate configuration
  doctor           Run health check

${C_BOLD}Utility Commands:${C_RESET}
  edit [target]    Edit config (registry|profile|skhd|yabai|hyprland)
  log [cmd]        Manage logs (tail|clear|path)
  install [opts]   Run installer
  help             Show this help

${C_BOLD}Examples:${C_RESET}
  uke gen                    # Generate all configs
  uke profile                # Open hardware profile TUI
  uke apply                  # Generate hardware ghost files
  uke gen && uke reload      # Apply changes
  uke edit                   # Edit registry.yaml

${C_BOLD}Workflow (New Machine):${C_RESET}
  1. uke profile             # Set hardware settings
  2. uke apply               # Generate ghost files
  3. uke gen && uke reload   # Generate and apply configs

${C_BOLD}Companion Commands:${C_RESET}
  uke-gather                 # Organize windows to workspaces
  uke-bunch <name>           # Run environment preset
  uke-scratchpad <name>      # Toggle scratchpad window
  uke-session <cmd>          # Save/restore window layouts
  uke-launch <app>           # Smart app launcher
  uke-doctor                 # Detailed health check
  uke-backup                 # Backup configs
  uke-debug                  # Diagnostics
  uke-logs [component]       # Live log viewer

EOF
}

# ==============================================================================
# Main
# ==============================================================================
case "${1:-help}" in
    gen|generate)      shift; cmd_gen "$@" ;;
    apply)             shift; cmd_apply "$@" ;;
    profile|prof)      shift; cmd_profile "$@" ;;
    reload)            cmd_reload ;;
    status|stat)       cmd_status ;;
    validate|val)      cmd_validate ;;
    edit)              shift; cmd_edit "$@" ;;
    log)               shift; cmd_log "$@" ;;
    install)           shift; cmd_install "$@" ;;
    doctor|doc)        shift; cmd_doctor "$@" ;;
    help|--help|-h)    cmd_help ;;
    version|--version|-v) echo "UKE v$UKE_VERSION" ;;
    *)
        log_error "Unknown command: $1"
        echo ""
        cmd_help
        exit 1
        ;;
esac
