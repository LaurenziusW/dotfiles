#!/usr/bin/env bash
# ==============================================================================
# UKE Scratchpad - Dropdown/Toggle Windows
# ==============================================================================
# Toggles scratchpad windows - special floating windows that appear on demand.
#
# Usage: uke-scratchpad <name>
# Names: terminal, notes, music, calc
# ==============================================================================
set -euo pipefail

# [FIX] Bash Version Auto-Detection & Reload
# macOS ships with Bash 3.2. This script requires Bash 4.0+ (associative arrays).
if [ -z "${BASH_VERSINFO}" ] || [ "${BASH_VERSINFO[0]}" -lt 4 ]; then
    if [ -x /opt/homebrew/bin/bash ]; then
        exec /opt/homebrew/bin/bash "$0" "$@"
    elif [ -x /usr/local/bin/bash ]; then
        exec /usr/local/bin/bash "$0" "$@"
    else
        echo "Error: Bash 4.0+ required (found ${BASH_VERSION})."
        echo "Please install bash via homebrew: brew install bash"
        exit 1
    fi
fi

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
export UKE_ROOT="${SCRIPT_DIR%/bin}"

source "$UKE_ROOT/lib/core.sh"

NAME="${1:-terminal}"

# ==============================================================================
# Scratchpad Configuration
# ==============================================================================
declare -A SCRATCH_APP
declare -A SCRATCH_CLASS

# macOS app names
SCRATCH_APP[terminal_macos]="WezTerm"
SCRATCH_APP[notes_macos]="Obsidian"
SCRATCH_APP[music_macos]="Spotify"
SCRATCH_APP[calc_macos]="Calculator"

# Linux app names
SCRATCH_APP[terminal_linux]="wezterm"
SCRATCH_APP[notes_linux]="obsidian"
SCRATCH_APP[music_linux]="spotify"
SCRATCH_APP[calc_linux]="gnome-calculator"

# Window classes for matching (Linux)
SCRATCH_CLASS[terminal]="wezterm"
SCRATCH_CLASS[notes]="obsidian"
SCRATCH_CLASS[music]="spotify"
SCRATCH_CLASS[calc]="gnome-calculator"

# ==============================================================================
# Get App for Platform
# ==============================================================================
get_scratch_app() {
    local name="$1"
    local key
    is_macos && key="${name}_macos" || key="${name}_linux"
    echo "${SCRATCH_APP[$key]:-}"
}

# ==============================================================================
# macOS Scratchpad (using yabai)
# ==============================================================================
scratchpad_macos() {
    local name="$1"
    local app
    app=$(get_scratch_app "$name")
    
    if [[ -z "$app" ]]; then
        log_fatal "Unknown scratchpad: $name"
    fi
    
    # Check if app window exists
    local window_id
    window_id=$(yabai -m query --windows | jq -r ".[] | select(.app == \"$app\") | .id" | head -1)
    
    if [[ -n "$window_id" ]]; then
        # Window exists - check if focused
        local focused
        focused=$(yabai -m query --windows --window | jq -r '.id' 2>/dev/null || echo "")
        
        if [[ "$focused" == "$window_id" ]]; then
            # Already focused - hide it (send to scratchpad space or minimize)
            yabai -m window "$window_id" --space 11 2>/dev/null || yabai -m window "$window_id" --minimize
            log_info "Hidden: $app"
        else
            # Not focused - bring to current space and focus
            yabai -m window "$window_id" --space mouse
            yabai -m window "$window_id" --focus
            yabai -m window "$window_id" --toggle float 2>/dev/null || true
            log_info "Focused: $app"
        fi
    else
        # Window doesn't exist - launch app
        open -a "$app"
        log_info "Launched: $app"
        
        # Wait and configure
        sleep 0.5
        window_id=$(yabai -m query --windows | jq -r ".[] | select(.app == \"$app\") | .id" | head -1)
        if [[ -n "$window_id" ]]; then
            yabai -m window "$window_id" --toggle float
            # Center and resize based on scratchpad type
            case "$name" in
                terminal)
                    yabai -m window "$window_id" --resize abs:1200:400
                    yabai -m window "$window_id" --move abs:100:50
                    ;;
                notes)
                    yabai -m window "$window_id" --resize abs:1000:800
                    yabai -m window "$window_id" --grid 8:8:1:1:6:6
                    ;;
                music)
                    yabai -m window "$window_id" --resize abs:800:600
                    yabai -m window "$window_id" --grid 8:8:2:2:4:4
                    ;;
                calc)
                    yabai -m window "$window_id" --grid 8:8:3:3:2:2
                    ;;
            esac
        fi
    fi
}

# ==============================================================================
# Linux Scratchpad (using Hyprland special workspaces)
# ==============================================================================
scratchpad_linux() {
    local name="$1"
    local app class
    app=$(get_scratch_app "$name")
    class="${SCRATCH_CLASS[$name]:-}"
    
    if [[ -z "$app" ]]; then
        log_fatal "Unknown scratchpad: $name"
    fi
    
    # Use Hyprland special workspaces
    local special_ws="special:$name"
    
    # Check if window exists in special workspace
    local window_count
    window_count=$(hyprctl clients -j | jq "[.[] | select(.workspace.name == \"$special_ws\")] | length")
    
    if [[ "$window_count" -gt 0 ]]; then
        # Toggle visibility
        hyprctl dispatch togglespecialworkspace "$name"
    else
        # Launch app into special workspace
        hyprctl dispatch exec "[workspace $special_ws] $app"
        sleep 0.3
        hyprctl dispatch togglespecialworkspace "$name"
    fi
    
    log_info "Toggled scratchpad: $name"
}

# ==============================================================================
# Main
# ==============================================================================
case "$NAME" in
    terminal|notes|music|calc)
        is_macos && scratchpad_macos "$NAME" || scratchpad_linux "$NAME"
        ;;
    list)
        echo "Available scratchpads: terminal, notes, music, calc"
        ;;
    *)
        log_fatal "Unknown scratchpad: $NAME (use: terminal|notes|music|calc)"
        ;;
esac
